\documentclass[11pt]{amsart}
%DIF LATEXDIFF DIFFERENCE FILE
%DIF DEL arXiv_EllipticSingularitiesSplitting.tex   Fri Jun 28 20:15:41 2019
%DIF ADD EllipticSingularitiesSplitting.tex         Thu Oct 15 10:11:18 2020
%\linespread{1.25}
\usepackage[margin=3.5cm]{geometry}

\usepackage[noend,boxruled]{algorithm2e}
%Customize appearance using line below:
\SetKwFor{For}{\normalfont{for}}{:}{endfor}

\usepackage[english]{babel}
\usepackage{appendix}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
%\usepackage{showlabels}
\usepackage{amsthm}
\usepackage{marginnote}
\usepackage{stmaryrd}
\usepackage{enumitem}
\usepackage[english]{babel}
\usepackage{yfonts}
\usepackage[T1]{fontenc}
\usepackage[utf8x]{inputenc}
\usepackage[normalem]{ulem}
%DIF 24a24
%\usepackage{enumerate} %DIF > 
%DIF -------

%Maybe need this
\usepackage[numbers]{natbib}

\renewcommand\thepart{\Roman{part}}

%This reverse-links the references in the paper. Useful for large papers.
%DIF 31c32
%DIF < \usepackage[backref]{hyperref}
%DIF -------
\usepackage[backref=page]{hyperref} %DIF > 
%DIF -------
\hypersetup{
  colorlinks   = true,          %Colors links instead of ugly boxes
%DIF 34-36c35-37
%DIF <   urlcolor     = violet,          %Color for external hyperlinks
%DIF <   linkcolor    = violet,          %Color of internal links
%DIF <   citecolor   = blue             %Color of citations
%DIF -------
  urlcolor     = red,          %Color for external hyperlinks %DIF > 
  linkcolor    = blue,          %Color of internal links %DIF > 
  citecolor   = violet             %Color of citations %DIF > 
%DIF -------
}

\usepackage{calrsfs}
\DeclareMathAlphabet{\pazocal}{OMS}{zplm}{m}{n}

%DIF 42a43-68
 %DIF > 
  %Cool Dots in the TOC, courtesy Tyler Foster %DIF > 
  \makeatletter %DIF > 
\def\@tocline#1#2#3#4#5#6#7{\relax %DIF > 
  \ifnum #1>\c@tocdepth % then omit %DIF > 
  \else %DIF > 
    \par \addpenalty\@secpenalty\addvspace{#2}% %DIF > 
    \begingroup \hyphenpenalty\@M %DIF > 
    \@ifempty{#4}{% %DIF > 
      \@tempdima\csname r@tocindent\number#1\endcsname\relax %DIF > 
    }{% %DIF > 
      \@tempdima#4\relax %DIF > 
    }% %DIF > 
    \parindent\z@ \leftskip#3\relax \advance\leftskip\@tempdima\relax %DIF > 
    \rightskip\@pnumwidth plus4em \parfillskip-\@pnumwidth %DIF > 
    #5\leavevmode\hskip-\@tempdima %DIF > 
      \ifcase #1 %DIF > 
       \or\or \hskip 1em \or \hskip 2em \else \hskip 3em \fi% %DIF > 
      #6\nobreak\relax %DIF > 
    \dotfill\hbox to\@pnumwidth{\@tocpagenum{#7}}\par %DIF > 
    \nobreak %DIF > 
    \endgroup %DIF > 
  \fi} %DIF > 
\makeatother %DIF > 
 %DIF > 
 %DIF > 
%DIF -------
\usepackage{verbatim}
\usepackage{graphicx}
\usepackage{verbatim}
\usepackage{faktor}
\usepackage{xcolor}
\usepackage{xfrac}
\usepackage{tikz,tikz-cd}
\usetikzlibrary{decorations.pathmorphing,decorations.pathreplacing,patterns,arrows.meta}


\definecolor{red}{rgb}{1,0,0}

\usepackage[all]{xy}
\usepackage{bbm}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage{tabu}
\usepackage{booktabs}
\usepackage{mathtools}

\usepackage[]{textcomp}
\usepackage[sups]{Baskervaldx}
\usepackage{cabin}
\usepackage[varqu,varl]{inconsolata}
\usepackage[baskervaldx,bigdelims,vvarbb]{newtxmath}
\usepackage[cal=cm]{mathalfa}


\newcommand{\plC}{\scalebox{0.8}[1.3]{$\sqsubset$}}
\newcommand{\sidenote}[1]{\marginpar{\textbf{\color{red}#1}}}
\newcommand{\lcm}{\operatorname{lcm}}

% FIGURES FOR USE LATER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\Yagraph{\tikz[baseline=-3pt,scale=.8]{
\draw (2,0) -- (0,1) (2,0) -- (0,.5) (2,0) -- (0,-1);
\draw (2,0) circle(2pt)[fill=black];
\draw [->] (2,0) -- (2.7,0);
\draw (2.6,0) node[right]{\tiny{$x_k$}};
\draw (0,1) circle(2pt)[fill=white];
\draw (0,.5) circle(2pt)[fill=black];
\draw (0,-.25) node{$\vdots$};
\draw (0,-1) circle(2pt)[fill=black];
\draw [blue,fill=blue] (0,-2) circle[radius=2pt];
\draw [->,blue,thick] (0,-2) -- (3,-2);
\draw [blue,fill=blue] (2,-2) circle[radius=2pt];
\draw [->,blue] (1,-0.9) -- (1,-1.6);

\draw [blue] (2,-2) node[above]{\tiny$\diamond$};
\draw [blue] (0,-2) node[above]{\tiny$0$};

\draw (2.05,0) node[above]{\tiny{$\sqC_0$}};
\draw (0,1) node[left]{\tiny{$\sqC_1$}};
\draw (0,.5) node[left]{\tiny{$\sqC_2$}};
\draw (0,-1) node[left]{\tiny{$\sqC_r$}};
}}

\def\Ybgraph{\tikz[baseline=-3pt,scale=.8]{
\draw (2,0) to[out=120,in=0] (0,1) (2,0) -- (0,1) (2,0) -- (0,.5) (2,0) -- (0,-1);
\draw (2,0) circle(2pt)[fill=black];
\draw [->] (2,0) -- (2.7,0);
\draw (2.6,0) node[right]{\tiny{$x_k$}};
\draw (0,1) circle(2pt)[fill=black];
\draw (0,.5) circle(2pt)[fill=black];
\draw (0,-.25) node{$\vdots$};
\draw (0,-1) circle(2pt)[fill=black];
\draw [blue,fill=blue] (0,-2) circle[radius=2pt];
\draw [->,blue,thick] (0,-2) -- (3,-2);
\draw [blue,fill=blue] (2,-2) circle[radius=2pt];
\draw [->,blue] (1,-0.9) -- (1,-1.6);
\draw [blue] (2,-2) node[above]{\tiny$\diamond$};
\draw [blue] (0,-2) node[above]{\tiny$0$};

\draw (2.05,0) node[above]{\tiny{$\sqC_0$}};
\draw (0,1) node[left]{\tiny{$\sqC_1$}};
\draw (0,.5) node[left]{\tiny{$\sqC_3$}};
\draw (0,-1) node[left]{\tiny{$\sqC_r$}};
}}

\def\Ycgraph{\tikz[baseline=-3pt,scale=.8]{
\draw (2,0) -- (0,1) (2,0) -- (0,.5) (2,0) -- (0,-1);
\draw [->] (2,0) -- (2.7,0);
\draw (2.6,0) node[right]{\tiny{$x_k$}};
\draw (2,0) circle(2pt)[fill=white];
\draw (0,1) circle(2pt)[fill=black];
\draw (0,.5) circle(2pt)[fill=black];
\draw (0,-.25) node{$\vdots$};
\draw (0,-1) circle(2pt)[fill=black];
\draw [blue,fill=blue] (0,-2) circle[radius=2pt];
\draw [->,blue,thick] (0,-2) -- (3,-2);
\draw [blue,fill=blue] (2,-2) circle[radius=2pt];
\draw [blue] (2,-2) node[above]{\tiny$\diamond$};
\draw [blue] (0,-2) node[above]{\tiny$0$};
\draw [->,blue] (1,-0.9) -- (1,-1.6);

\draw (2.05,0) node[above]{\tiny{$\sqC_0$}};
\draw (0,1) node[left]{\tiny{$\sqC_1$}};
\draw (0,.5) node[left]{\tiny{$\sqC_2$}};
\draw (0,-1) node[left]{\tiny{$\sqC_r$}};
}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\tred}{\textcolor{red}}
\newcommand{\mathsq}[1]{#1}

\newcommand{\sqC}{\scalebox{0.8}[1.3]{$\sqsubset$}}
\newcommand{\Kim}{\operatorname{Kim}}
\newcommand{\ACGS}{\operatorname{ACGS}}

\newcommand{\pM}{\pazocal{M}}
\newcommand{\TT}{\operatorname{T}}
\newcommand{\oM}{\overline{\mathcal{M}}}
\newcommand{\M}[4]{\overline{\mathcal{M}}_{#1,#2}(#3,#4)}

\newcommand{\Mlog}[4]{\overline{\mathcal{M}}^{\operatorname{log}}_{#1,#2}(#3,#4)}
\newcommand{\MLog}{\overline{\mathcal{M}}^{\operatorname{log}}}
\newcommand{\Mpunct}[4]{\overline{\mathcal{M}}^{\operatorname{punct}}_{#1,#2}(#3,#4)}
\newcommand{\MG}[4]{\overline{\mathcal{M}}^{\rm G}_{#1,#2}(#3,#4)}
\newcommand{\Q}[4]{\mathcal{Q}_{#1,#2}(#3,#4)}
\newcommand{\Qe}[4]{\mathcal{Q}^{\epsilon}_{#1,#2}(#3,#4)}
\newcommand{\Qt}[4]{\widetilde{\mathcal Q}_{#1,#2}(#3,#4)}
\newcommand{\QG}[4]{\mathcal{Q}G_{#1,#2}(#3,#4)}
\newcommand{\QGe}[4]{\mathcal{Q}G^{\epsilon}_{#1,#2}(#3,#4)}
\newcommand{\D}[3]{\mathcal{D^Q}(#1,#2,#3)}
\newcommand{\E}[3]{\mathcal{E^Q}(#1,#2,#3)}
\newcommand{\PP}{\mathbb P}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\VZ}{\pazocal{V\!Z}}
\newcommand{\tVZc}[4]{\widetilde{\mathcal{V\!Z}}^{\rm{ctr}}_{#1,#2}(#3,#4)}
\newcommand{\VZc}[4]{\mathcal{V\!Z}_{#1,#2}(#3,#4)}
\newcommand{\VZcLi}[4]{\mathcal{V\!Z}^{\rm{ctr, Li}}_{#1,#2}(#3,#4)}
\newcommand{\VZrel}[4]{\mathcal{V\!Z}^{\rm{rel}}_{#1,#2}(#3,#4)}
\newcommand{\stab}{\rm{stab}}
\newcommand{\st}{\star}
\newcommand{\stC}{C'}
\newcommand{\stpi}{\pi'}
\newcommand{\sts}{s'}
\newcommand{\N}{\mathbb{N}}
\newcommand{\OO}{\mathcal{O}}
\renewcommand{\to}{\rightarrow}
\newcommand{\A}{\mathcal A}
\newcommand{\B}{\mathcal B}
\newcommand{\C}{\mathfrak C}
\newcommand{\cC}{\mathcal C}
\newcommand{\EE}{\mathbf{E}}
\renewcommand{\L}{\mathcal L}
\newcommand{\LL}{\mathbf{L}}
\newcommand{\MM}{\mathfrak M}
\newcommand{\Aaff}{\mathbb{A}}
\newcommand{\kfield}{\Bbbk}
\newcommand{\comp}{\chi}
\newcommand{\sst}{\sigma^{\operatorname{ss}}}
\newcommand{\Pic}{\operatorname{Pic}}
\newcommand{\Def}{\operatorname{Def}}
\newcommand{\Spec}{\operatorname{Spec}}
\newcommand{\Proj}{\operatorname{Proj}}
\newcommand{\Hom}{\operatorname{Hom}}
\newcommand{\Ext}{\operatorname{Ext}}
\newcommand{\Gm}{\mathbb{G}_{\text{m}}}
\newcommand{\virt}[1]{[#1]^{\operatorname{virt}}}
\newcommand{\vip}[1]{[#1]^{\operatorname{prod}}}
\newcommand{\Id}{\operatorname{Id}}
\newcommand{\CC}{\mathbb{C}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\HH}{\operatorname{H}}
\newcommand{\Glog}{\mathbb{G}_{\mathrm{log}}}
\newcommand{\Achow}{\operatorname{A}}
\newcommand{\pt}{\operatorname{pt}}
\newcommand{\bq}{\begin{equation}}
\newcommand{\eq}{\end{equation}}
\newcommand{\ba}{\begin{aligned}}
\newcommand{\ea}{\end{aligned}}
\newcommand{\be}{\begin{enumerate}}
\newcommand{\ee}{\end{enumerate}}
\newcommand{\bsm}{\left(\begin{smallmatrix}}
\newcommand{\esm}{\end{smallmatrix}\right)}                   
\newcommand{\bpm}{\begin{pmatrix}}
\newcommand{\epm}{\end{pmatrix}}
\newcommand{\barr}{\begin{displaymath}\begin{array}{cccc}}
\newcommand{\earr}{\end{array}\end{displaymath}}
\newcommand{\barrl}{\begin{displaymath}\begin{array}{lcl}}
\newcommand{\earrl}{\end{array}\end{displaymath}}
\newcommand{\barl}{\begin{displaymath}\begin{array}{l}}
\newcommand{\earl}{\end{array}\end{displaymath}}
\newcommand{\bxym}{ \begin{displaymath}\xymatrix }
\newcommand{\exym}{\end{displaymath}}
\newcommand{\bcd}{\begin{center}\begin{tikzcd}}
\newcommand{\ecd}{\end{tikzcd}\end{center}}
\newcommand{\R}{\operatorname{R}^{\bullet}}
\newcommand{\dvr}{\Delta}
%\newcommand{\sslash}{\mathbin{/\mkern-6mu/}}
\newcommand{\tr}{{\rm tr}}
\newcommand{\Isom}{\text{Isom}}
\newcommand{\pr}{\operatorname{pr}}
\newcommand{\ev}{\operatorname{ev}}
\newcommand{\fgt}{\operatorname{fgt}}
\newcommand{\codim}{\operatorname{codim}}
\newcommand{\vdim}{\operatorname{vdim}}
\newcommand{\ildef}[1]{\emph{#1}}
\newcommand{\om}[1]{\mathcal{#1}}
\newcommand{\h}{\operatorname{h}}
\newcommand{\Aut}{\operatorname{Aut}}
\newcommand{\Acal}{\mathcal{A}}
\newcommand{\Scal}{\mathcal{S}}
\newcommand{\Mcal}{\mathcal{M}}
\newcommand{\Dcal}{\mathcal{D}}
\newcommand{\Ecal}{\mathcal{E}}
\newcommand{\Ncal}{\mathcal{N}}
\newcommand{\Fcal}{\mathcal{F}}
\newcommand{\Lcal}{\mathcal{L}}
\newcommand{\Ccal}{\mathcal{C}}
\newcommand{\Pcal}{\mathcal{P}}
\newcommand{\Ycal}{\mathcal{Y}}
\newcommand{\cchern}{\mathrm{c}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\op}[1]{\operatorname{#1}}
\newcommand{\gp}{\operatorname{gp}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\ovm}[1]{\overline{\mathcal{#1}}}
\newcommand{\ovt}[1]{\widetilde{\mathcal{#1}}}
\newcommand{\ov}[1]{\overline{#1}}
%DIF 265a292-293
 %DIF > 
\DeclareMathOperator{\spec}{Spec} %DIF > 
%DIF -------

\theoremstyle{definition}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}
\newtheorem*{teo*}{Theorem}
\newtheorem{ipotesi}{ipotesi}
\newtheorem*{nota}{Nota}
\newtheorem{claim}{Claim}
\newtheorem{question}[thm]{Question}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{notation}[thm]{Notation}

\newtheorem{innercustomthm}{Theorem}
\newenvironment{customthm}[1]
  {\renewcommand\theinnercustomthm{#1}\innercustomthm}
  {\endinnercustomthm}

\theoremstyle{definition}
\newtheorem{example}[thm]{Example}
\newtheorem{ex}[thm]{Example}
\newtheorem{dfn}[thm]{Definition}
\newtheorem{definition}[thm]{Definition}
\newtheorem{aside}[thm]{Aside}
\newtheorem{remark}[thm]{Remark}
\newtheorem{com}[thm]{Comment}
\newtheorem{num}{Number}
\newtheorem*{sketch}{Sketch}
\newtheorem*{rem}{Remark}
\newtheorem*{aside*}{Aside}
\newtheorem*{acknowledgements}{Acknowledgements}

\newlist{steps}{enumerate}{1}
\setlist[steps, 1]{label = Step (\arabic*):}

\newcommand{\ilemph}[1]{\emph{#1}}

\setcounter{tocdepth}{1}

\newcommand{\todo}[1]{\vspace{5mm}\par \noindent
\framebox{\begin{minipage}[c]{0.95 \textwidth} \tt #1\end{minipage}} \vspace{5mm} \par}

\def\ti{-\allowhyphens}
\newcommand{\thismonth}{\ifcase\month % case 0 --- impossible!
  \or January\or February\or March\or April\or May\or June%
  \or July\or August\or September\or October\or November%
  \or December\fi}
\newcommand{\thismonthyear}{{\thismonth} {\number\year}}
\newcommand{\thisdaymonthyear}{{\number\day} {\thismonth} {\number\year}}

\title[Curve counting in genus one: elliptic singularities {\it \&}  relative geometry]{Curve counting in genus one: \DIFaddbegin \\ \DIFaddend elliptic singularities {\it \&} relative geometry}
\author{Luca Battistella, Navid Nabijou and Dhruv Ranganathan}
%DIF PREAMBLE EXTENSION ADDED BY LATEXDIFF
%DIF UNDERLINE PREAMBLE %DIF PREAMBLE
\RequirePackage[normalem]{ulem} %DIF PREAMBLE
\RequirePackage{color}\definecolor{RED}{rgb}{1,0,0}\definecolor{BLUE}{rgb}{0,0,1} %DIF PREAMBLE
\providecommand{\DIFaddtex}[1]{{\protect\color{blue}\uwave{#1}}} %DIF PREAMBLE
\providecommand{\DIFdeltex}[1]{{\protect\color{red}\sout{#1}}}                      %DIF PREAMBLE
%DIF SAFE PREAMBLE %DIF PREAMBLE
\providecommand{\DIFaddbegin}{} %DIF PREAMBLE
\providecommand{\DIFaddend}{} %DIF PREAMBLE
\providecommand{\DIFdelbegin}{} %DIF PREAMBLE
\providecommand{\DIFdelend}{} %DIF PREAMBLE
%DIF FLOATSAFE PREAMBLE %DIF PREAMBLE
\providecommand{\DIFaddFL}[1]{\DIFadd{#1}} %DIF PREAMBLE
\providecommand{\DIFdelFL}[1]{\DIFdel{#1}} %DIF PREAMBLE
\providecommand{\DIFaddbeginFL}{} %DIF PREAMBLE
\providecommand{\DIFaddendFL}{} %DIF PREAMBLE
\providecommand{\DIFdelbeginFL}{} %DIF PREAMBLE
\providecommand{\DIFdelendFL}{} %DIF PREAMBLE
%DIF END PREAMBLE EXTENSION ADDED BY LATEXDIFF
%DIF PREAMBLE EXTENSION ADDED BY LATEXDIFF
%DIF HYPERREF PREAMBLE %DIF PREAMBLE
\providecommand{\DIFadd}[1]{\texorpdfstring{\DIFaddtex{#1}}{#1}} %DIF PREAMBLE
\providecommand{\DIFdel}[1]{\texorpdfstring{\DIFdeltex{#1}}{}} %DIF PREAMBLE
%DIF END PREAMBLE EXTENSION ADDED BY LATEXDIFF

\begin{document}


\begin{abstract}
We construct and study the reduced, relative, genus one Gromov--Witten theory of very ample pairs. These invariants form the principal component contribution to relative Gromov--Witten theory in genus one and are relative versions of Zinger's reduced Gromov--Witten invariants. We relate the relative and absolute theories by degeneration of the tangency conditions, and the resulting formulas generalise a well-known recursive calculation scheme put forward by Gathmann in genus zero. The geometric input is a desingularisation of the principal component of the moduli space of genus one logarithmic stable maps to a very ample pair, using the geometry of elliptic singularities. Our study passes through general techniques for calculating integrals on logarithmic blowups of moduli spaces of stable maps, which may be of independent interest.
\end{abstract}

\maketitle

\appendixtitletocoff
\tableofcontents

\DIFdelbegin %DIFDELCMD < \setcounter{section}{-1}
%DIFDELCMD < %%%
\section{\DIFdel{Introduction}}
%DIFAUXCMD
\addtocounter{section}{-1}%DIFAUXCMD
\DIFdelend \DIFaddbegin \setcounter{section}{0}

\section*{\DIFadd{Introduction}}
\DIFaddend 

The Kontsevich moduli space of stable maps from genus zero curves to projective space exhibits remarkable geometry -- it is a smooth orbifold with a ``self-similar'' normal crossings boundary. These facts have combined to produce a very {satisfactory} understanding of Gromov--Witten theory in genus zero. 

\DIFdelbegin \DIFdel{While the }\DIFdelend \DIFaddbegin \DIFadd{The }\DIFaddend higher genus situation is much more \DIFdelbegin \DIFdel{difficult, in the last several years, }\DIFdelend \DIFaddbegin \DIFadd{delicate, and }\DIFaddend substantial theory has been developed \DIFdelbegin \DIFdel{towards a conceptual understanding of }\DIFdelend \DIFaddbegin \DIFadd{in recent years to treat }\DIFaddend the genus one case\DIFaddbegin \DIFadd{, both for its intrinsic geometry, and for higher genus insights}\DIFaddend . This began over a decade ago with \DIFdelbegin \DIFdel{the }\DIFdelend pioneering work of Li, Vakil, and Zinger~\cite{redgone,VZ,LZ,lz2,zingerstvsred,zingred}, and was recently reinvigorated using ideas from singularity theory~\DIFdelbegin \DIFdel{\mbox{%DIFAUXCMD
\cite{BCM18,CM18,HL,SMY1,VISC} }%DIFAUXCMD
}\DIFdelend \DIFaddbegin \DIFadd{\mbox{%DIFAUXCMD
\cite{BCM18,HL,SMY1,VISC} }%DIFAUXCMD
}\DIFaddend and logarithmic geometry~\cite{RSPW,RSPW2}. The result is a \textbf{reduced} Gromov--Witten theory, which removes \DIFdelbegin \DIFdel{certain }\DIFdelend degenerate contributions from the ordinary theory. While the Atiyah--Bott localisation for the reduced invariants was used to great effect by Zinger in his proof of the BCOV conjectures, two major components of the \DIFdelbegin \DIFdel{standard theory }\DIFdelend \DIFaddbegin \DIFadd{subject }\DIFaddend -- relative invariants and the degeneration formula -- have not been developed in this setting. Our \DIFdelbegin \DIFdel{results in this paper provide }\DIFdelend \DIFaddbegin \DIFadd{work provides }\DIFaddend these as new {structural} tools in reduced genus one Gromov--Witten theory\footnote{Further motivation to consider the genus one case specifically comes simply from the fact that for Calabi--Yau geometries in dimension larger than $3$, Gromov--Witten theory vanishes in genera greater than one.}. \DIFaddbegin \DIFadd{While the essential starting point is the early work on relative Gromov--Witten theory by Gathmann, modern tools are required in our setting. We establish both the conceptual framework and the formula by combining tropical geometry and logarithmic Gromov--Witten theory, as developed by Abramovich--Chen--Gross--Siebert, with the recent understanding of elliptic singularities and their interactions with logarithmic structures. 
}\DIFaddend 


\subsection{Results} Our first contribution is \DIFdelbegin \DIFdel{a definition and construction of reduced }\DIFdelend \DIFaddbegin \DIFadd{the construction of a }\textbf{\DIFadd{reduced relative}} \DIFaddend Gromov--Witten theory \DIFdelbegin \DIFdel{of projective space relative to a hyperplane. }\DIFdelend \DIFaddbegin \DIFadd{associated to elliptic curves in $\mathbb P^N$ with prescribed tangency along a hyperplane, and analogous invariants associated to smooth pairs $(X,Y)$ with $Y$ very ample. Our reduced relative theory differs from relative Gromov--Witten theory in a parallel fashion to how Li--Zinger's reduced Gromov--Witten theory differs from the standard theory. 
}

\DIFaddend The geometric content is the following \DIFdelbegin \DIFdel{, see \S \ref{section construction} for a precise formulation. }%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend \DIFaddbegin \DIFadd{theorem, which provides a smooth and proper moduli space compactifying the space of elliptic curves in projective space with prescribed contact order data. }\DIFaddend Let $\mathcal M_{1,\alpha}^\circ(\mathbb P^N|H,d)$ be the moduli space of positive degree maps from smooth curves of genus one to $\mathbb P^N$ with dimensionally transverse contact order $\alpha\in\mathbb Z^n_{\geq 0}$ along $H$. \DIFaddbegin \DIFadd{A precise version of the following theorem requires a certain amount of tropical and logarithmic language, and is therefore stated precisely in \S \ref{section construction}.
}\DIFaddend 

\begin{customthm}{A}\label{thm: desingularization}
There exists a logarithmically smooth and proper Deligne--Mumford stack $\VZ_{1,\alpha}(\mathbb P^N|H,d)$ having expected dimension, and containing $\mathcal M_{1,\alpha}^\circ(\mathbb P^N|H,d)$  as a dense open subset. A point in this moduli space \DIFdelbegin \DIFdel{parameterises maps
}\DIFdelend \DIFaddbegin \DIFadd{determines commutative diagrams
}\DIFaddend
\DIFaddbegin \DIFadd{where $C$ is a nodal genus $1$ curve, $\overline C_1$ and $\overline C_2$ are Gorenstein curves of genus $1$, the map $C\to \PP^N[s]$ is a logarithmic map }\DIFaddend to an $s$-fold expansion of \DIFdelbegin \DIFdel{$\mathbb P^N$ }\DIFdelend \DIFaddbegin \DIFadd{$\PP^N$ }\DIFaddend along $H$\DIFdelbegin \DIFdel{such that the map to the expansion and composite map $C\to \mathbb P^N$ each factor nontrivially through an elliptic singularity}\DIFdelend \DIFaddbegin \DIFadd{, and each of the vertical is }\textbf{\DIFadd{non-degenerate}}\DIFaddend .
\end{customthm}

\DIFdelbegin \DIFdel{The moduli space above is constructed by identifying two closed conditions that must be satisfied by the space of maps to the pair $(\mathbb P^N,H)$. Each condition requires the stable map to factor through an elliptic singularity. The behaviour mixes the geometry in ~\mbox{%DIFAUXCMD
\cite{RSPW} }%DIFAUXCMD
and~\mbox{%DIFAUXCMD
\cite{RSPW2}}%DIFAUXCMD
. }%DIFDELCMD < {%%%
\DIFdel{Together with an analysis of the deformation theory of such maps, we are led to Theorem~\ref{thm: desingularization}}%DIFDELCMD < }%%%
\DIFdelend \DIFaddbegin \DIFadd{Intuitively, non-degeneracy is the condition that the maps in question are non-constant on some branch of the minimal genus $1$ subcurve, see  \S \ref{section construction} for details}\DIFaddend .

\DIFdelbegin \DIFdel{Our second result explains how to do practical calculations on this space of stable maps}\DIFdelend %DIF > The moduli space above is constructed by identifying two closed conditions that must be satisfied by maps to the pair $(\mathbb P^N,H)$. Each condition requires the stable map to factor through an elliptic singularity, and the conditions together are required for the relative and absolute reduced theories to be related appropriately.  {An analysis of the deformation theory of such maps leads to Theorem~\ref{thm: desingularization}}.
\DIFaddbegin 

\DIFadd{The information involving singularities adds substantial complexity to the theory, and this motivates our next result, which shows that calculations are nonetheless possible}\DIFaddend . 

\begin{customthm}{B}\label{thm: recursion}
Given a smooth pair $(X,Y)$ with $Y$ very ample, there is an explicit recursive algorithm to calculate
 \begin{enumerate} 
\item the (restricted) reduced genus one Gromov--Witten invariants of $Y$;
\item the reduced genus one relative Gromov--Witten invariants of $(X,Y)$; 
\item the (restricted) reduced genus one rubber invariants of $\mathbb{P}=\PP_Y(\operatorname{N}_{Y|X} \oplus \OO_Y)$
 \end{enumerate} 
from the \DIFdelbegin \DIFdel{full }\DIFdelend \DIFaddbegin \DIFadd{absolute }\DIFaddend genus zero and \DIFaddbegin \DIFadd{absolute }\DIFaddend reduced genus one invariants of \DIFdelbegin \DIFdel{the ambient variety }\DIFdelend $X$.
\end{customthm}

This reconstruction result \DIFdelbegin \DIFdel{is most directly a generalisation of Gathmann's one}\DIFdelend \DIFaddbegin \DIFadd{generalies that of Gathmann}\DIFaddend ~\cite{Ga}. A higher genus reconstruction result for the ordinary theory is proved \DIFdelbegin \DIFdel{in a paper of }\DIFdelend \DIFaddbegin \DIFadd{by }\DIFaddend Maulik and Pandharipande~\cite{MaulikPandharipande}, but follows a fundamentally different strategy to ours. In particular, localisation is never used in the analysis here, nor in the work of Gathmann. 

We pursue a strategy laid out by Vakil, building on work of Caporaso and Harris~\cite{CH98,Vre}. The first step is to express the locus of maps where the contact order degenerates in terms of Chern classes of tautological vector bundles. The second step is to describe that locus in terms of fibre products of moduli spaces with smaller invariants. 

Novelties are introduced in both steps. In the first, we describe the locus of degenerate maps as the zero locus of a logarithmic line bundle, arising from a piecewise linear function with a simple moduli theoretic description. The use of tropical techniques substantially simplifies Gathmann's calculations.

For the second step, we \DIFaddbegin \DIFadd{are forced to }\DIFaddend contend with the interaction of the relative splitting formula and the geometry of elliptic singularities, which is entirely new (\S \ref{subsection C0 splitting}). We express the factorisation condition -- central to the constructions in~\cite{RSPW,RSPW2} -- in terms of tautological classes, leading to Theorem~\ref{thm: recursion}.

\subsection{\DIFdelbegin \DIFdel{Broader contributions}\DIFdelend \DIFaddbegin \DIFadd{Context and further discussion}\DIFaddend } \DIFdelbegin \DIFdel{Beyond genus one, we pass through some useful general techniques . First, we }\DIFdelend \DIFaddbegin \DIFadd{This paper is a most directly related to recent work on aligned logarithmic structures, elliptic singularities, and stable maps, as developed in~\mbox{%DIFAUXCMD
\cite{RSPW,RSPW2}}%DIFAUXCMD
. The moduli spaces we construct lie in between the absolute and toric-boundary-relative geometries studied in the first and second of those papers, respectively. The degeneration algorithm presented here as a first practical implementation of the theory developed in that work. 
}

\DIFadd{We pass through general techniques that we expect will be useful in logarithmic Gromov--Witten theory more broadly. We }\DIFaddend explain how to describe degenerate moduli spaces \DIFdelbegin \DIFdel{as fibre products}\DIFdelend \DIFaddbegin \DIFadd{in terms of simpler spaces of maps}\DIFaddend . This is substantially more delicate than the standard situation\DIFdelbegin \DIFdel{for two reasons. On the one hand, we need to study }\DIFdelend \DIFaddbegin \DIFadd{, where the strata are simply fibre products. First, one must understand }\DIFaddend the interaction of the relative geometry with elliptic singularities, which involves a study of the factorisation condition in terms of tautological \DIFdelbegin \DIFdel{vector bundles. On the other hand}\DIFdelend \DIFaddbegin \DIFadd{bundles. Second}\DIFaddend , the degenerate strata of moduli spaces are not simply fibre products of spaces with smaller numerical invariants, but compactified torus bundles over these strata, due to the introduction of logarithmic blowups. This geometry is \DIFdelbegin \DIFdel{present throughout logarithmic enumerative geometry, particularly in }\DIFdelend \DIFaddbegin \DIFadd{at the heart of recent work on }\DIFaddend the degeneration formula\DIFdelbegin \DIFdel{, and we provide }\DIFdelend \DIFaddbegin \DIFadd{~\mbox{%DIFAUXCMD
\cite{R19}}%DIFAUXCMD
. The main text provides }\DIFaddend a first systematic procedure that \DIFdelbegin \DIFdel{explains how to use }\DIFdelend \DIFaddbegin \DIFadd{uses }\DIFaddend tropical geometry to calculate with these torus bundles\DIFdelbegin \DIFdel{~\mbox{%DIFAUXCMD
\cite{R19}}%DIFAUXCMD
.
}%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdel{In addition, the results of~\mbox{%DIFAUXCMD
\cite{RSPW} }%DIFAUXCMD
suggest the existence of a reduced higher genus Gromov--Witten theory formed by replacing contracted elliptic components with singularities}\footnote{\DIFdel{We have been informed by Jonathan Wise that his Ph.D. candidate Sebastian Bozlee has constructed these higher genus reduced Gromov--Witten invariants. A manuscript is in preparation.}}%DIFAUXCMD
\addtocounter{footnote}{-1}%DIFAUXCMD
\DIFdel{. The discussion here is likely to carry over to this setting}\DIFdelend . 

\DIFdelbegin \DIFdel{Second, a }\DIFdelend \DIFaddbegin \DIFadd{A }\DIFaddend key step in our recursion is a description of the locus of maps with higher than prescribed tangency, which was identified by Gathmann. We realise the locus as the vanishing locus of a section of a line bundle that comes from tropical geometry — from a piecewise linear function on the fan. The systematic understanding of logarithmic line bundles arising in this fashion is likely to play an important \DIFdelbegin \DIFdel{r\^ole }\DIFdelend \DIFaddbegin \DIFadd{role }\DIFaddend in logarithmic enumerative geometry. 

\DIFdelbegin \DIFdel{We rephrase }\DIFdelend \DIFaddbegin \DIFadd{Although the geometric ideas in }\DIFaddend Gathmann's \DIFdelbegin \DIFdel{idea of increasing the tangency requirement within the framework of logarithmic stable maps(where maximal tangency is always assumed) by introducing }\emph{\DIFdel{fictitious markings}}%DIFAUXCMD
\DIFdel{, and identifying the }\DIFdelend \DIFaddbegin \DIFadd{recursion are clear, they are implemented within the }\DIFaddend space of \DIFdelbegin \DIFdel{maps with higher contact order with a boundary stratum inside that of lower contact order and more (fictitious) markings}\DIFdelend \DIFaddbegin \DIFadd{ordinary stable maps, and do not formally fit within the formalism of logarithmic Gromov--Witten theory. On the way to our main results, we reinterpret Gathmann's idea of increasing tangency within logarithmic mapping spaces. %DIF > This is done by the introduction of \emph{fictitious markings}, and an identification of the space of maps with higher contact order with a boundary stratum inside that of lower contact order and more (fictitious) markings. 
}

%DIF > Our methods require us to work simultaneously with several variants of the space of relative/logarithmic stable maps, with fixed and expanded target. The conceptual features of one space are often computational bugs, and vice versa. Kato's perspective on logarithmic blowups as subfunctors lies at the heart of these ideas. We believe that the techniques developed in the genus one case here will be used repeatedly in logarithmic Gromov--Witten theory calculations. The necessity of working with multiple virtual birational models in logarithmic enumerative geometry is apparent in recent and ongoing work of a number of researchers, and we hope that the methods developed here will be useful more broadly. 

\subsection{\DIFadd{Future directions}} \DIFadd{The results of~\mbox{%DIFAUXCMD
\cite{RSPW} }%DIFAUXCMD
also suggest the existence of a reduced higher genus Gromov--Witten theory formed by replacing contracted elliptic components with singularities. We have been informed by Jonathan Wise that his Ph.D. candidate Sebastian Bozlee has constructed these higher genus reduced Gromov--Witten invariants. A manuscript is in preparation. The discussion here is expected to carry over to this setting}\DIFaddend . 

Our analysis leads naturally to the study of \DIFdelbegin \DIFdel{a ``main component ’’ }\DIFdelend \DIFaddbegin \DIFadd{the main component of the }\DIFaddend double ramification cycle for target manifolds in genus one. The virtual geometry of this was studied in recent work of Janda, Pandharipande, Pixton, and Zvonkine~\cite{DRCBundle}. \DIFdelbegin \DIFdel{We do not know how to calculate a closed formula for this main component contribution (except in the case where the target manifold is a point), but we repurpose E.~Katz's topological recursion relations \mbox{%DIFAUXCMD
\cite{EKatz} }%DIFAUXCMD
to complete the algorithm. We note that even }\DIFdelend \DIFaddbegin \DIFadd{Even }\DIFaddend in genus one, an understanding of the main component contributions of the double ramification cycle for target manifolds \DIFdelbegin \DIFdel{would be interesting}\DIFdelend \DIFaddbegin \DIFadd{seems to be lacking. Our main algorithm subverts the use of this class, but it would be more natural to use it}\DIFaddend . 

Finally, \DIFdelbegin \DIFdel{we note that our methods require us to encounter several variants of the space of relative/logarithmic stable maps, with both fixed and expanded target. The conceptual features of one space are often computational bugs, and vice versa, and we believe that the techniques developed in the genus one case here will be used repeatedly in logarithmic Gromov--Witten theory calculations. In particular, we frequently use Kato's perspective on logarithmic blowups as subfunctors that was applied in~\mbox{%DIFAUXCMD
\cite{RSPW,RSPW2}}%DIFAUXCMD
. }\DIFdelend \DIFaddbegin \DIFadd{it would be natural to generalize the method of degenerating tangency conditions to targets with higher rank logarithmic structures. The extreme case when the target is a toric variety with its toric boundary, is intimately tied with the enumerative geometry of well-spaced tropical curves~\mbox{%DIFAUXCMD
\cite{LR18,RSPW2,Speyer}}%DIFAUXCMD
. %DIF > We will return to these questions in future work. 
}\DIFaddend 

\subsection*{Acknowledgements} We have benefited from fruitful conversations with friends and colleagues, including Pierrick Bousseau, Francesca Carocci, Cristina Manolache, Davesh Maulik, Keli Santos-Parker, and Jonathan Wise. The \DIFaddbegin \DIFadd{comments of an anonymous referee have proved very valuable. The }\DIFaddend authors worked on this project during visits to MPIM-Bonn, MIT, University of Cambridge, and the University of Glasgow, and thank these institutions for ideal working conditions and support. L.B. and N.N. would in addition like to thank Imperial College London, the LSGNT, the Royal Society, 3CinG, and the MSRI program ''Enumerative Geometry beyond Numbers''. \DIFaddbegin \DIFadd{N.N. was partially supported by EPSRC grant EP/R009325/1.
}\DIFaddend 

%\part{ The moduli space and its deformation theory}

\section{Constructions and logarithmic smoothness}\label{section construction}

\DIFaddbegin \DIFadd{We briefly review some basic tropical structures in the theory of logarithmic curves and logarithmic stable maps. A detailed treatment is given by~\mbox{%DIFAUXCMD
\cite[Section~3]{CavalieriChanUlirschWise}}%DIFAUXCMD
. The following paragraphs are meant only as a reminder. 
}

\subsection*{\DIFadd{Curves and tropical curves}} \DIFadd{A nodal curve $C$ over $\spec \mathbb C$ has an associated dual graph $\Gamma(C)$. Given a toric monoid $P$, there is a logarithmic point $\spec \CC_P$ which may be thought of as remembering the information of an embedding of a closed point into the toric variety $\spec \mathbb C[P]$. For a logarithmically smooth curve $C$ over $\spec \CC_P$, the dual graph $\Gamma(C)$ is enhanced: given an edge $e$ of $\Gamma(C)$, the logarithmic structure keeps track of a generalized ``edge length'' $\ell_e$, which is an element of $P$. These data can be repackaged into a cone complex $\plC$ together with a map to the dual cone $\sigma_P$
}\[
\DIFadd{\pi: \plC\to \sigma_P.
}\]
\DIFadd{A fiber of this map $\pi$ is a metric space enhancing the topological space $\Gamma(C)$, with edges given lengths in $\RR_{\geq 0}$. Over the interior of the cone $\sigma_P$ these edge lengths are nonzero, and the fibers are homoemorphic to $\Gamma(C)$. Over the faces of $\sigma_P$, the fibers can be identified with edge collapses. 
}

\DIFadd{The discussion is globalized in~\mbox{%DIFAUXCMD
\cite{CavalieriChanUlirschWise}}%DIFAUXCMD
, and the construction can be carried out for the universal curve over the moduli space of logarithmic curves. Specifically, there is a stack over the category of cone complexes $\mathfrak M_{g,n}^{\mathrm{trop}}$ equipped with a universal curve 
}\[
\DIFadd{\plC\to \mathfrak M_{g,n}^{\mathrm{trop}}.
}\]
\DIFadd{The reader is encourage to think of $\mathfrak M_{g,n}^{\mathrm{trop}}$ as playing the same role for $\mathfrak M_{g,n}$ as a fan plays for a toric variety. In particular, two constructions are relevant:
} \begin{enumerate} 
\item \DIFadd{A subdivision of $\mathfrak M_{g,n}^{\mathrm{trop}}$ gives rise to a birational modification of $\mathfrak M_{g,n}$.
}\item \DIFadd{A piecewise linear function on $\mathfrak M_{g,n}^{\mathrm{trop}}$ gives rise to a Cartier divisor on $\mathfrak M_{g,n}$.
} \end{enumerate} 

\subsection*{\DIFadd{Maps and tropical maps}}\DIFadd{The discussion carries over to the setting of logarithmic maps. Specifically, given a logarithmic curve $C$ and a logarithmic map to a smooth pair $(X,Y)$ over a logarithmic scheme $S$. For simplicity, assume that $S$ is a $P$-logarithmic point, as above. There is an associated }\textbf{\DIFadd{tropicalization}}\DIFadd{, i.e. a family of tropical curves $\plC$ over $\sigma_P$, together with a map of cone complexes
}\[
\DIFadd{\plC\to \RR_{\geq 0}.
}\]
\DIFadd{Each fiber over $\sigma_P$ encodes a metric enhancement of the dual graph, together with a piecewise linear map to $\RR_{\geq 0}$. There is once again a cone stack representing the moduli problem of tropical maps; the technical details are only cosmetically different than those presented in~\mbox{%DIFAUXCMD
\cite{CavalieriChanUlirschWise}}%DIFAUXCMD
, and we leave these details to the reader. 
}

\subsection{\DIFadd{Maps from curves and elliptic singularities}} \DIFadd{We provide a brief intuitive picture that underlies the work in~\mbox{%DIFAUXCMD
\cite{RSPW,RSPW2}}%DIFAUXCMD
. If $C$ is a Gorenstein curve and $f:C\to \mathbb P^N$ is a morphism, the ampleness of the the tangent bundle of $\mathbb P^N$ ensures that if no subcurve of arithmetic genus $1$ is contracted, the deformations of $f$ are unobstructed. In fact, the deformations }\textit{\DIFadd{over the stack of curves}} \DIFadd{are also unobstructed. The moduli space of Gorenstein genus $1$ is not smooth. However, a more sophisticated moduli problem, consisting of nodal curves together with a }\textit{\DIFadd{chosen contraction}} \DIFadd{to a Gorenstein curve, might be expected to resolve these singularities. The formation of such a moduli problem requires logarithmic geometry, and is achieved in~\mbox{%DIFAUXCMD
\cite[Section~3]{RSPW}}%DIFAUXCMD
. Once constructed, the corresponding moduli of stable maps out of a Gorenstein curve is also resolved. Note that maps from nodal genus $1$ curves may have stable limits that contract genus $1$ subcurves, but the allowance of Gorenstein singularities ensures that properness despite disallowing contracted genus $1$ components. 
}

\DIFadd{When working with logarithmic geometries such as $(\mathbb P^N,H)$ as we do here, similar ideas may be expected to apply, but the deformation theory of maps becomes more delicate. Indeed, the logarithmic Euler sequence for this pair shows that the logarithmic tangent bundle is a quotient of $\mathcal O\oplus\mathcal O(1)^{\oplus 1}$, and additional obstructions appear. In simple terms, there exist logarithmic maps to the pair $(\mathbb P^N,H)$ with obstructed logarithmic deformations, whose underlying ordinary stable map is unobstructed. 
}

\DIFaddend \subsection{\DIFdelbegin \DIFdel{The absolute case}\DIFdelend \DIFaddbegin \DIFadd{Absolute geometry: reminders}\DIFaddend } Let $\mathfrak M_{1,n}$ be the logarithmic algebraic stack of $n$-pointed prestable curves of genus one. We begin by recalling the logarithmic moduli spaces of genus one curves constructed in~\cite[\S 2 \& \S 4]{RSPW}. 
\DIFdelbegin \DIFdel{Given }\DIFdelend \DIFaddbegin 

\DIFadd{Consider }\DIFaddend a logarithmically smooth curve $C$ over a logarithmic geometric point $S$ \DIFdelbegin \DIFdel{, let $\plC$ }\DIFdelend \DIFaddbegin \DIFadd{with monoid $P$ and let $\pi: \plC\to \sigma_P$ }\DIFaddend denote its tropicalization\DIFdelbegin \DIFdel{, and let $\lambda \in \overline{M}_{S}$ be the piecewise-linear function giving the distance from each vertex of $\sqC$ to the minimal genus one subcurve. 
}\DIFdelend \DIFaddbegin \DIFadd{. Given a point $t$ in $\sigma_P$ we obtain a metric graph as explained above. Since the curve in question has genus $1$, there is a minimal genus $1$ subgraph -- either a vertex of genus $1$ or a cycle in the graph. We will refer to this as the }\textbf{\DIFadd{core}}\DIFadd{. Given a point $s$ with $\pi(s)$ equal to $t$, there is a well-defined distance in the metric graph $\pi^{-1}(t)$ from $s$ to the core. 
}

\DIFadd{In particular, for each vertex $v$ of the dual graph $\Gamma(C)$, i.e. each component of $C$, there is a well-defined function $\lambda(v): \sigma_P\to \RR_{\geq 0}$, defined on the base of the tropical family. Given any other piecewise linear function $\delta$ on $\sigma_P$, say that $\delta$ is }\textbf{\DIFadd{comparable}} \DIFadd{to $\lambda(v)$ if there is a global order relation, either $\lambda(v)\leq \delta$ or $\lambda(v)\geq \delta$, that holds at all points of $\sigma_P$. 
}

\DIFadd{Piecewise linear functions on $\sigma_P$ are naturally identified with global sections of the characteristic sheaf $\overline M_S$. Given an arbitrary logarithmically smooth curve $C/S$, conditions involving the comparability of piecewise linear functions can be imposed geometric point-by-point. This leads to the following definition. 
}

\DIFaddend \begin{definition}
A \textbf{centrally aligned curve} is a pair $(C/S,\delta)$, where $\delta\in\overline{M}_S$, such that:
 \begin{enumerate} 
    \item the section $\delta$ is comparable to $\lambda(v)$ for all vertices $v$ of $\plC$;
    \item for any pair of vertices $v$ and $w$ of distance less than $\delta$, the sections $\lambda(v)$ and $\lambda(w)$ are comparable.
 \end{enumerate} 
\end{definition}
In \DIFdelbegin \DIFdel{essence, this says that the }\DIFdelend \DIFaddbegin \DIFadd{other words, for the tropical }\DIFaddend curve $\sqC$\DIFdelbegin \DIFdel{is such that }\DIFdelend \DIFaddbegin \DIFadd{, }\DIFaddend all vertices are either inside, outside, or on the circle of radius $\delta$ \DIFdelbegin \DIFdel{, and that }\DIFdelend \DIFaddbegin \DIFadd{regardless of the point on the base; }\DIFaddend the collection of vertices inside the circle is totally ordered \DIFaddbegin \DIFadd{by their distance to the core}\DIFaddend .

The moduli stack $\mathfrak M_{1,n}^{\mathrm{cen}}$  of centrally aligned curves is a logarithmic algebraic stack in the smooth topology, and $\mathfrak M_{1,n}^{\mathrm{cen}}\to\mathfrak M_{1,n}$ is a logarithmic modification. The main construction of~\cite{RSPW} canonically associates to any centrally aligned family of curves $\mathcal C_S$ a partial destabilisation $\widetilde{\mathcal C}_S$\DIFaddbegin \DIFadd{, introducing $2$-pointed components, }\DIFaddend and a contraction
\[
\widetilde{\mathcal C}_S\to \overline{\mathcal C}_S,
\]
where $\overline{\mathcal C}_S$ may contain a Gorenstein elliptic singularity \cite{SMY1}. \DIFdelbegin \DIFdel{The number of branches }\DIFdelend \DIFaddbegin \DIFadd{Given a family of tropical curves, the function $\delta$ provides a non-negative real number for each point on the base. We may therefore consider the ``circle'' of points on each fiber whose distance from the minimal genus $1$ subgraph }\DIFaddend is equal to \DIFdelbegin \DIFdel{the sum of }\DIFdelend \DIFaddbegin \DIFadd{$\delta$. The partial destabilization, or ``bubbling'', introduces $2$-pointed rational curves into the curve by adding vertices to the dual graph at the points that lie on this circle. The number of branches is equal to }\DIFaddend the number of vertices of $\widetilde{\sqC}$ which lie on the circle of radius $\delta$. \DIFdelbegin \DIFdel{This data uniquely determines the singularity.
}\DIFdelend %DIF > This data uniquely determines the singularity.

The space of stable maps $\widetilde\VZ_{1,n}(\PP^N,d)$ from the universal nodal curve $\mathcal C$ over the stack $\mathfrak M_{1,n}^{\mathrm{cen}}$ is proper and algebraic, with projective coarse moduli space. A compatibility condition between the alignment and the map is required, namely that the circle of radius $\delta$ passes through at least one component of positive degree. A stable map in this space is said to satisfy the \textbf{factorisation condition} if the map $\mathcal C\to \mathbb P^N$ factors through the contraction $\widetilde{\mathcal C}\to \overline{\mathcal C}$. \DIFaddbegin \DIFadd{For ease of language, maps from nodal curves that are not constant on any subcurve of genus $1$ are taken to satisfy this condition. 
 }\DIFaddend 

\begin{thm}[{\cite[Theorem B]{RSPW}}]
The substack $\VZ_{1,n}(\mathbb P^N,d)$ of $\widetilde\VZ_{1,n}(\PP^N,d)$ parameterising maps to $\mathbb P^N$ that satisfy the factorisation condition is smooth and proper of the expected dimension.
\end{thm}

\DIFaddbegin \begin{remark}[Constant maps]\label{rem: constant-maps}
\DIFadd{When the degree of the map is $1$, maps from smooth genus $1$ curves to $\PP^N$ are constant. The interior of the moduli space of stable maps in this case is empty, though the compactification by stable maps is non-empty. The space of maps satisfying the factorization condition is also empty. Only non-empty cases are considered. 
}\end{remark}

\DIFaddend The remainder of this section lifts this construction to the category of relative maps to \DIFdelbegin \DIFdel{the pair }\DIFdelend $(\mathbb P^N,H)$. The core \DIFdelbegin \DIFdel{of the result is identifying the necessary factorisation conditions that }\DIFdelend \DIFaddbegin \DIFadd{result shows that two factorisation conditions }\DIFaddend remove the obstructions. 

\subsection{Relative geometry: compactification} Fix a hyperplane $H\subseteq \mathbb P^N$. Let $\alpha$ be a partition of the degree $d>0$. Consider the moduli space $\mathcal M_{1,\alpha}^\circ(\mathbb P^N|H,d)$ of maps from smooth elliptic curves $C\to \mathbb P^N$ that meet $H$ at finitely many marked points with vanishing orders given by the partition $\alpha$. This is a smooth, but non-proper Deligne--Mumford stack. 

We \DIFdelbegin \DIFdel{will first }\DIFdelend compactify the space described above, and then desingularise it. For the compactification, we begin with Abramovich--Chen--Gross--Siebert's space of logarithmic stable maps, though we will \DIFdelbegin \DIFdel{typically work with various subcategories and }\DIFdelend \DIFaddbegin \DIFadd{work with }\DIFaddend variants~\cite{AbramovichChenLog,ChenLog,GrossSiebertLog,KimLog}.

Let $\PP^N$ be endowed with the divisorial logarithmic structure induced by $H$. The moduli space $\overline{\mathcal{M}}^{\operatorname{log}}_{1,\alpha}(\mathbb P^N|H,d)$ is a fibred category over logarithmic schemes, whose fibre over $(S,M_S)$ is the groupoid of logarithmically smooth curves of genus one over $(S,M_S)$ equipped with a logarithmic map to $\mathbb P^N$ of degree $d$ and contact order $\alpha$. It is a fundamental fact in the subject that this category is representable by a proper algebraic stack with logarithmic structure, parameterising minimal objects~\cite{ChenLog}. 

%%%%%
\begin{comment}
There is a representable finite logarithmic morphism to the Kontsevich space, forgetting the logarithmic structure on the target:
$$
\overline{\mathcal M}^{\mathrm{log}}_{1,\alpha}(\mathbb P^N|H,d) \to \overline{\mathcal M}_{1,n}(\mathbb P^N,d).
$$
\end{comment}
%%%%%%%%%%%%%%

\begin{comment}
As in the absolute setting, we consider the space of logarithmic morphisms from the universal curve $\mathcal{C} \to \mathfrak{M}_{1,n}^{\mathrm{cen}}$ to the logarithmic scheme $(\PP^N,H)$. We impose a compatibility condition, which says that the radius must pass through a vertex of positive degree in $\PP^N$ and contain only vertices of degree zero in its strict interior. In this way we obtain a logarithmic modification
\begin{equation*} \widetilde\VZ_{1,\alpha}(\PP^N|H,d) \to \ol\Mcal^{\mathrm{log}}_{1,\alpha}(\PP^N|H,d)\end{equation*}
which we refer to as the \textbf{moduli space of centrally aligned maps to $(\PP^N,H)$}. It is a logarithmic modification of $\overline{\mathcal M}^{\mathrm{log}}_{1,\alpha}(\mathbb P^N|H,d)$. We note that by definition this space maps down to $\widetilde\VZ_{1,n}(\PP^N,d)$, by forgetting the logarithmic structure of the target.
\end{comment}

\subsection{Relative geometry: expansions} 

\begin{comment}Our next task is to pick out a non-singular principal component in $\widetilde{\VZ}_{1,\alpha}(\mathbb P^N|H,d)$. The principal component of this space, consisting of the closure of the space of maps from nonsingular curves, maps into the principal component of $\widetilde\VZ_{1,n}(\PP^N,d)$. Indeed, smoothable logarithmic maps are, in particular, smoothable as ordinary maps. An additional condition is required to isolate the principal component of the space of logarithmic maps. \end{comment}

In order make the obstruction theory more geometric, we expand the target. To elucidate the connection with the static target, consider a logarithmic stable map $[C\to (\mathbb P^N,H)]$ over $\mathrm{Spec} \ (\mathbb N\to \mathbb C)$. At the level of tropicalizations, there is a map of fans
\[
\plC\to \mathbb R_{\geq 0}.
\]
Choose a subdivision of $\mathbb R_{\geq 0}$ whose vertices \DIFdelbegin \DIFdel{consist of }\DIFdelend \DIFaddbegin \DIFadd{are }\DIFaddend the images of vertices of $\plC$. Pull this subdivision back to $\plC$ by \DIFdelbegin \DIFdel{marking all }\DIFdelend \DIFaddbegin \DIFadd{subdividing }\DIFaddend preimages of the vertices of $\mathbb R_{\geq 0}$. Denote the resulting map $\widetilde \plC \to \widetilde{\mathbb R}_{\geq 0}$. \DIFdelbegin %DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend These subdivisions induce logarithmic modifications
\[
\widetilde C\to \mathbb P^N[s],
\]
see~\cite{AW}. Here the latter is the $s$-times iterated deformation to the normal cone of $H$ in $\mathbb P^N$. The irreducible components of the target are in bijection with the vertices in $\widetilde{\mathbb R}_{\geq 0}$. The curve is modified by adding rational components \DIFdelbegin \DIFdel{corresponding to }\DIFdelend \DIFaddbegin \DIFadd{for }\DIFaddend the newly introduced vertices.

The result is a logarithmic stable map to an expanded target $\mathbb P^N[s]$, together with a contraction to the main target component $\mathbb P^N[s]\to\mathbb P^N$. Two maps are considered equivalent if they differ by $\Gm$-scaling the target at higher level. This is the logarithmic enhancement of the classical theory of relative stable maps, due to Li \cite{Li1,Li2}.

Globally, Kim constructs a moduli space of logarithmic \DIFdelbegin \DIFdel{stable }\DIFdelend maps to expanded degenerations, which on logarithmic points, reduces to the above construction~\cite{KimLog}. \DIFdelbegin \DIFdel{Indeed, by the above description, }\DIFdelend Kim's space is identified with a subcategory of the Abramovich--Chen--Gross--Siebert space, and its dual minimal monoids are cones in a subdivision of the dual minimal cones of the unexpanded space\DIFdelbegin \DIFdel{. This process is outlined in complete generality in}\DIFdelend \DIFaddbegin \DIFadd{, see}\DIFaddend ~\cite[\S~2]{R19}. 

\DIFdelbegin \DIFdel{Since we will work mostly with expansions , we will }\DIFdelend \DIFaddbegin \DIFadd{We typically work with expansions for convenience, and }\DIFaddend use the notation
$\ol\Mcal_{1,\alpha}(\PP^N|H,d)$
for Kim's space of logarithmic stable maps\DIFdelbegin \DIFdel{, with the understanding that this may just as easily be viewed as a logarithmic modification of the Abramovich--Chen--Gross--Siebert space}\DIFdelend .

\subsection{Relative geometry: alignment} \DIFdelbegin \DIFdel{As in the absolute setting, we }\DIFdelend \DIFaddbegin \DIFadd{We }\DIFaddend consider the space of logarithmic morphisms from the universal curve $\mathcal{C} \to \mathfrak{M}_{1,n}^{\mathrm{cen}}$ to the logarithmic scheme $(\PP^N,H)$. As in the absolute case, we require the radius to pass through a vertex of positive degree in $\PP^N$ and contain only vertices of degree zero in its strict interior\DIFdelbegin \DIFdel{, but the alignment must also be compatible with the logarithmic map}\DIFdelend . In this way we obtain a logarithmic modification of the Abramovich--Chen--Gross--Siebert space. If we further perform the subdivisions of target and source outlined in the previous section, we obtain a logarithmic modification of Kim's space:
\begin{equation*} \widetilde\VZ_{1,\alpha}(\PP^N|H,d) \to \ol\Mcal_{1,\alpha}(\PP^N|H,d)\end{equation*}
which we refer to as the \textbf{moduli space of centrally aligned maps} to $(\PP^N,H)$. This space parametrises transverse logarithmic maps to the expanded target with an alignment which is compatible with the map. Because of this compatibility condition, there is a morphism
\begin{equation*} \widetilde\VZ_{1,\alpha}(\PP^N|H,d) \to \widetilde\VZ_{1,n}(\PP^N,d)\end{equation*}
obtained by forgetting the logarithmic structure on the target and collapsing the map.


\subsection{Relative geometry: factorisation}\label{subsection factorisation} Let $[C\to \mathbb P^N[s]\to \mathbb P^N]$ be a centrally aligned logarithmic map. Recall that $\mathbb P^N[s]$ consists of a union of $\mathbb P^N$ with $s$ copies of the projective bundle $\mathbb{P} = \mathbb P(\mathcal O_H\oplus \mathcal O_H(1))$. We refer to these latter components as \textbf{the higher levels}. Thus, we will say that a subcurve $D\subseteq C$ maps to \textbf{higher level} if the \DIFdelbegin \DIFdel{collapsed map
}\[
\DIFdel{C\to \mathbb P^N
}\]
%DIFAUXCMD
\DIFdelend \DIFaddbegin \DIFadd{composite $C\to \mathbb P^N$ }\DIFaddend maps $D$ into $H\subset \mathbb P^N$. 

Let $D_F\subseteq C$ be the maximal genus one subcurve which is mapped to a higher level and contracted by the map $C\to \mathbb P^N[s]$. Let $\delta_F$ denote the distance from the core to the nearest component of $C \setminus D_F$. Similarly let $D_B\subseteq C$ be the maximal genus one subcurve that is contracted by the collapsed map to $\mathbb P^N$ and let $\delta_B$ be the associated radius. This coincides with the radius of the underlying map to $\mathbb P^N$. Of course, $\delta_F\leq \delta_B$, so $(C,\delta_F)$ is centrally aligned\DIFdelbegin \DIFdel{also}\DIFdelend .

The datum $(\delta_F,\delta_B)$ determines a destabilisation $\widetilde C$ of $C$ together with successive contractions $\widetilde C\to \overline C_F\to\overline C_B$. The contractions are constructed \DIFdelbegin \DIFdel{directly from}\DIFdelend \DIFaddbegin \DIFadd{by}\DIFaddend ~\cite[Section~3]{RSPW}.

\DIFaddbegin \DIFadd{A Gorenstein elliptic singularity has a number of }\textbf{\DIFadd{branches}}\DIFadd{. Given a curve $\overline C$ of genus $1$ with such a singularity, define a branch of $\overline C$ to be an irreducible component containing a branch of the singularity. If the curve $C$ is nodal, then its branches will be understood to be the components of its minimal arithmetic genus $1$ subcurve, i.e. its core. }\DIFaddend The following condition identifies the locus of smoothable maps. 

\begin{definition}
The map $[C\to \mathbb P^N[s]\to \mathbb P^N]$ \textbf{factorises completely} if 
 \begin{enumerate} 
\item the map $C\to \mathbb P^N[s]$ factors through $\overline C_F$ such that \DIFaddbegin \DIFadd{$F$ is non-constant on }\DIFaddend at least one branch of $\overline C_F$\DIFdelbegin \DIFdel{has positive degree in the fibre direction; 
}\DIFdelend \DIFaddbegin \DIFadd{,
}\DIFaddend \item the collapsed map to $\mathbb P^N$ factorises through $\overline C_B$ such that at least one branch of $\overline C_B$ has positive degree.
 \end{enumerate} 
\DIFaddbegin \DIFadd{The factorisation conditions are understood to be satisfied when $C\to \mathbb P^N[s]$ (resp. $C\to \mathbb P^N$) does not contract a genus $1$ subcurve. 
}\DIFaddend \end{definition}

\DIFdelbegin \DIFdel{In particular, if }\DIFdelend \DIFaddbegin \DIFadd{If }\DIFaddend $[C\to \mathbb P^N[s]\to \mathbb P^N]$ is a family of centrally aligned maps over $S$ that factorises completely, there is a \DIFdelbegin \DIFdel{forgetful }\DIFdelend moduli map $S\to \VZ_{1,n}(\mathbb P^N,d)$, to the principal component of the space of absolute maps. Let
\begin{equation*} \VZ_{1,\alpha}(\mathbb P^N|H,d) \subseteq \widetilde\VZ_{1,\alpha}(\PP^N|H,d) \end{equation*}
be the stack of maps from centrally aligned curves to expansions \DIFdelbegin \DIFdel{of $\mathbb P^N$ }\DIFdelend that factorise completely.

\begin{thm}\label{thm: log-smoothness}
The stack $\VZ_{1,\alpha}(\mathbb P^N|H,d)$ is \DIFdelbegin \DIFdel{proper and logarithmically smooth over $\mathrm{Spec} \ \mathbb C$}\DIFdelend \DIFaddbegin \DIFadd{logarithmically smooth and proper of the expected dimension}\DIFaddend .
\end{thm}

\DIFaddbegin \DIFadd{As noted in Remark~\ref{rem: constant-maps}, maps from elliptic curves to $\PP^N$ will always be taken to have degree at least $2$, ensuring that the main component is non-empty. 
}

\DIFaddend \begin{proof}
We \DIFdelbegin \DIFdel{prove the results via }\DIFdelend \DIFaddbegin \DIFadd{examine the geometry of the space of maps to $(\PP^N|H)$ by utilising }\DIFaddend the forgetful morphism
$$
\nu: \VZ_{1,\alpha}(\mathbb P^N|H,d)\to \VZ_{1,n}(\mathbb P^N,d),
$$
which remembers only the stabilisation of the collapsed map. \DIFdelbegin \DIFdel{The }\DIFdelend \DIFaddbegin \DIFadd{To see that the such a forgetful morphism exists, observe for a map $[C\to \mathbb P^N[s]\to \mathbb P^N]$, the stabilised composite }\DIFaddend map is certainly centrally aligned, and \DIFdelbegin \DIFdel{we have already argued above that }\DIFdelend it satisfies the \DIFdelbegin \DIFdel{factorisation property for $\mathbb P^N$ after composition}\DIFdelend \DIFaddbegin \DIFadd{factorization property by construction}\DIFaddend . The moduli space $\VZ_{1,\alpha}(\mathbb P^N|H,d)$ is proper. Indeed, the verification of the valuative criterion follows \DIFdelbegin \DIFdel{exactly as in }\DIFdelend \DIFaddbegin \DIFadd{from }\DIFaddend Vakil's Lemma~\cite[Lemma~5.9]{Vre}. A direct proof that the factorisation property is a closed condition may be found in~\cite[Theorem~4.3]{RSPW}.

We come to logarithmic smoothness. If the elliptic curve does not map into higher level, then \DIFdelbegin \DIFdel{unobstructedness proceeds }\DIFdelend \DIFaddbegin \DIFadd{deformations of the map are unobstructed }\DIFaddend exactly as in~\cite[Section~4.5]{RSPW}.

Assume now that the elliptic curve maps into higher level. Note that the relative logarithmic tangent bundle of the expansion, over the base $\mathbb P^N$ is a trivial line bundle of rank $1$, as the fibres are toric. Consider an $S$-family of maps. After replacing the source $C$ by a destabilisation, we have maps
\bcd
C \ar[r] & \overline{C}_F \ar[r] \ar[d] & \overline{C}_B \ar[d] \\
& \mathbb P^N[s] \ar[r] & \mathbb P^N
\ecd
factorising completely. Let $f_B$ and $f$ be the maps from $C$ to the base and total space respectively. Examining the morphism $\nu$, we see that there is a map
\[
\mathrm{Def}(C,f_B)\to \mathrm{Obs}(f/(C,f_B)) = H^1(\overline{C}_F,\mathcal O_{\overline{C}_F}),
\]
where the former is the space of \DIFaddbegin \DIFadd{logarithmic }\DIFaddend deformations of the curve and map to the base, as a factorised centrally aligned map. \DIFdelbegin \DIFdel{The latter is the space of obstructions to lifting a map to the base into the total space. The }\DIFdelend \DIFaddbegin \DIFadd{More precisely, consider a strict square zero extension of $S$ and a deformation of the map $(C,f_B)$ satisfying the factorisation property. Since the deformation is strict, there is a canonically induced deformation of the expansion $\mathbb P^N[s]$. The corresponding element in $\mathrm{Obs}(f/(C,f_B))$ is the obstruction to lifting the deformation of $(C,f_B)$ to this canonical deformation of $\mathbb P^N[s]$ over $\mathbb P^N$. By comparing the cotangent complexes of the source, target, and fiber of the morphism $\nu$, we see that the }\DIFaddend cokernel of this map are the absolute \DIFdelbegin \DIFdel{obstructions, which we will show vanishes}\DIFdelend \DIFaddbegin \DIFadd{logarithmic obstructions for the map. We will show these vanish}\DIFaddend , proving logarithmic smoothness.

\DIFdelbegin \DIFdel{We note }\DIFdelend \DIFaddbegin \DIFadd{Consider }\DIFaddend the manner in which \DIFdelbegin \DIFdel{the group }\DIFdelend $H^1(\overline{C}_F,\mathcal O_{\overline{C}_F})$ functions as the obstruction group for the lifting. \DIFdelbegin \DIFdel{It suffices to work near }\DIFdelend \DIFaddbegin \DIFadd{Near }\DIFaddend the minimal genus one subcurve $D_F$ of $C$, \DIFdelbegin \DIFdel{since the rest of the curve is rational. This lifting is given by }\DIFdelend \DIFaddbegin \DIFadd{in order to lift the map from $\mathbb P^N$ to the expansion, we must provide }\DIFaddend a rational function \DIFdelbegin \DIFdel{with prescribed orders of poles given by the slopes of the tropicalizationmap. That is, }\DIFdelend \DIFaddbegin \DIFadd{on $D_F$ with poles bounded the divisor associated to the tropicalization, i.e. }\DIFaddend if $\alpha$ \DIFdelbegin \DIFdel{be }\DIFdelend \DIFaddbegin \DIFadd{is }\DIFaddend the piecewise linear function giving this tropical map, \DIFdelbegin \DIFdel{then }\DIFdelend the lifting is described by a section of the associated bundle $\mathcal O_{C}(-\alpha)$.

Given a strict square-zero extension $S'$ of $S$, the piecewise linear function $\alpha$ extends uniquely by strictness to any deformation of the curve. The resulting deformation of $\mathcal O_{C}(-\alpha)$ produces an infinitesimal deformation of the trivial bundle in the Picard group, whose class in $H^1(\overline{C}_F,\mathcal O_{\overline{C}_F})$, is the obstruction to deformation. We will show that it is possible to choose a deformation of $(C,f_B)$ that cancels out the obstruction to lifting to $f$, and thus the map to the obstruction space above is surjective. 

\DIFdelbegin \DIFdel{The }\DIFdelend \DIFaddbegin \DIFadd{On restricting to the minimal genus $1$ subcurve $D_F$, the }\DIFaddend line bundle $\mathcal O_{C}(-\alpha)$ is equivalent to the divisor $\sum a_i x_i$ where $x_i$ are the points connecting $D_F$ to the rest of the curve, and $a_i$ are the slopes of $\alpha$ along the edges corresponding to the $x_i$. Infinitesimally moving the point $x_i$ \DIFdelbegin \DIFdel{is a }\DIFdelend \DIFaddbegin \DIFadd{produces a nontrivial }\DIFaddend deformation of the \DIFdelbegin \DIFdel{curve that is unobstructed by the map $f_B$, since the map is constant on the interior of the circle of radius $\delta_B$. By deforming the $x_i$, at least one of which has nonzero $a_i$, we produce a one-dimensional space of obstructions}\DIFdelend \DIFaddbegin \DIFadd{line bundle $\mathcal O_{C}(-\alpha)$. The moduli space $\VZ_{1,n}(\mathbb P^N,d)$ is a logarithmically fibration over the universal Picard stack over the stack of $n$-pointed genus $1$ curves~\mbox{%DIFAUXCMD
\cite[Remark~4.5.3]{RSPW}}%DIFAUXCMD
. As a consequence, it is possible to find a logarithmic deformation of the map $(C,f_B)$ that induces the deformation of the line bundle that is given by infinitesimal motion. The obstruction group is $1$-dimensional, and we have produced a logarithmic deformation of the collapsed map that produces a nontrivial deformation of the line bundle $\mathcal O_{C}(-\alpha)$. Therefore, logarithmic deformations surject onto the obstruction space above}\DIFaddend . The absolute obstructions\DIFaddbegin \DIFadd{, which are the cokernel of this map }\DIFaddend therefore vanish, \DIFdelbegin \DIFdel{so }\DIFdelend \DIFaddbegin \DIFadd{and }\DIFaddend the result follows.  
%Consider an $S$-family of expanded maps $[F: C\to \mathbb P^N[s]$. Choose $N$ generic hyperplanes in and let $\Delta = \{H\}\cup\{H_1,\ldots,H_N}$ be this set of hyperplanes. There is a morphism of logarithmic schemes $(\mathbb P^N,\Delta)\to (\mathbb P^N,H)$. This induces a new expansion $\mathbb P^N[\Delta,s]$. Moreover, by the genericity of the $H_i$, they each intersect the image of $C$ in finitely many reduced points. Pulling back the logarithmic structure, we obtain a new logarithmic map 
%\[
%F': C'\to \mathbb P^N[\Delta,s].
%\]
%We make two observations. First, since the logarithmic structure on $C'$ is strict away from $H$, unobstructedness of deformations for $F'$ is equivalent to unobstructedness for $F$. Second, the target degeneration is now a toric degeneration, and the logarithmic tangent bundle is trivial.
\end{proof}

The \DIFdelbegin \DIFdel{above }\DIFdelend theorem guarantees that the singularities of the space of totally factorised maps to expansions is logarithmically smooth. \DIFdelbegin \DIFdel{In fact, one }\DIFdelend \DIFaddbegin \DIFadd{One }\DIFaddend can say more in this case.

\begin{cor}
The logarithmically smooth stack $\VZ_{1,\alpha}(\mathbb P^N|H,d)$ has at worst orbifold singularities, i.e. admits a non-representable cover by a smooth Deligne--Mumford stack.
\end{cor}

\begin{proof}
Since $\VZ_{1,\alpha}(\mathbb P^N|H,d)$ is logarithmically smooth, it will suffice to show that the cones of its tropicalization are simplicial. To see this, consider a logarithmic stable map to an expansion $C\to \mathbb P^N[s]$ without a central alignment. The tropical moduli cone obtained as the dual of the minimal base monoid can be identified with $\mathbb R_{\geq 0}^{s}$, see for instance~\cite[Section~2.2]{ChenDegeneration}. The alignment procedure is an iterated barycentric subdivision at the level of tropical moduli spaces, as explained in~\cite[Section 4.6]{RSPW}, and such subdivisions preserve the property of being simplicial. We conclude from this that the blowup $\widetilde{\VZ}^{\mathrm{exp}}_{1,\alpha}(\mathbb P^N|H,d)$ obtained by centrally aligning Kim's spaces has simplicial cones. \DIFdelbegin \DIFdel{Finally, the }\DIFdelend \DIFaddbegin \DIFadd{The }\DIFaddend morphism $\VZ_{1,\alpha}(\mathbb P^N|H,d)\to \widetilde{\VZ}^{\mathrm{exp}}_{1,\alpha}(\mathbb P^N|H,d)$ is strict, so the cones of $\VZ_{1,\alpha}(\mathbb P^N|H,d)$ are simplicial, as claimed.
\end{proof}

\subsection{Rubber variants}\label{subsection rubber} \DIFdelbegin \DIFdel{In our implementation of the relative theory, we will need the }\DIFdelend \DIFaddbegin \DIFadd{We require a }\DIFaddend ``rubber'' variant of the space of maps $
\VZ_{1,\alpha}(\mathbb P^N|H,d)$, where the \DIFdelbegin \DIFdel{entire curve is mapped into }\DIFdelend \DIFaddbegin \DIFadd{curve is contained in the }\DIFaddend higher levels.

\DIFdelbegin \DIFdel{Specifically, let }\DIFdelend \DIFaddbegin \DIFadd{Let }\DIFaddend $\mathbb P$ denote the projective bundle $\mathbb P(\mathcal O(1)\oplus\mathcal O)$ on $\mathbb P^{N-1}$. Equip this space with the logarithmic structure coming from the $0$ and $\infty$ sections of the bundle. Consider the moduli space $\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P|H_0+H_\infty,d)$ of logarithmic maps
\[
C\to \mathbb P[s]\to \mathbb P^{N-1},
\]
which factorise completely, and where automorphisms are \DIFdelbegin \DIFdel{considered over the space of maps }\DIFdelend \DIFaddbegin \DIFadd{taken to cover the identity on the map }\DIFaddend to $\mathbb P^{N-1}$\DIFdelbegin \DIFdel{. Specifically, }\DIFdelend \DIFaddbegin \DIFadd{; }\DIFaddend two maps that differ by a $\mathbb G_{\operatorname{m}}$ translate in the fibre direction are considered equivalent. \DIFdelbegin \DIFdel{Total factorisation, similar to the previous case, means that }\DIFdelend \DIFaddbegin \DIFadd{As previously, }\DIFaddend the map to the bundle and the map to the base $\mathbb P^{N-1}$ both factorise through possibly different singularities. 

\begin{thm}\label{thm rubber log smooth}
The stack $\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P|H_0+H_\infty,d)$ is logarithmically smooth \DIFaddbegin \DIFadd{and proper of the expected dimension}\DIFaddend .
\end{thm}

The main point in the proof \DIFdelbegin \DIFdel{of this statement }\DIFdelend is that on the space of non-degenerate maps with smooth domains, the map from $\VZ^\circ_{1,\alpha}(\mathbb P|H_0+H_\infty,d)\to \VZ^{\leftrightarrow,\circ}_{1,\alpha}(\mathbb P|H_0+H_\infty,d)$ is a $\mathbb G_{\operatorname{m}}$-torsor. \DIFdelbegin \DIFdel{Correspondingly, }\DIFdelend \DIFaddbegin \DIFadd{One expects that }\DIFaddend the map on compact moduli spaces is a nodal curve fibration. To prove this, it is convenient to work with the logarithmic multiplicative group and its torsors. Recall that the \textbf{logarithmic multiplicative group} $\mathbb G_{\mathrm{log}}$ is the functor on logarithmic schemes whose value on a logarithmic scheme $S$ is the group of global sections $H^0(S,M_S^{\mathrm{gp}})$; it is a proper group functor, and it contains $\Gm$ as a subfunctor. This functor is representable only after a logarithmically \'etale cover\DIFdelbegin \DIFdel{. Background may be found in}\DIFdelend \DIFaddbegin \DIFadd{, see for instance}\DIFaddend ~\cite{MW17,RW19}.

Each fibre of the bundle $\mathbb P \to \mathbb P^{N-1}$ admits a natural log \'etale morphism to $\mathbb G_{\mathrm{log}}$. Replacing these fibres by $\mathbb G_{\mathrm{log}}$, we obtain a non-representable functor on logarithmic schemes $\mathbb P_{\mathrm{log}}$ and a logarithmically \'etale modification
\[
\mathbb P\to \mathbb P_{\mathrm{log}}.
\]

%%%%%%%%%%%%%%%
\begin{comment}
%Bundle can have higher levels, so should rephrase this
The bundle $\mathbb P\to \mathbb P^{N-1}$ gives rise to a $\mathbb G_{\operatorname{m}}$-torsor by deleting the zero and infinity sections. Replacing these fibres by their $\mathbb G_{\mathrm{log}}$ compactifications, we obtain a non-representable functor on logarithmic schemes $\mathbb P_{\mathrm{log}}$ and a logarithmically \'etale modification
\[
\mathbb P\to \mathbb P_{\mathrm{log}}.
\]
\end{comment}
%%%%%%%%%%%%%%

\begin{proof}[Proof of Theorem \ref{thm rubber log smooth}]
Consider the stack over logarithmic schemes $\VZ_{1,\alpha}(\mathbb P_{\mathrm{log}},d)$ of stable logarithmic maps that factorise completely. Here, stability for the map coincides with stability for the projection to $\mathbb P^{N-1}$. The arguments in the previous section show that maps to $\mathbb P$ that factorise completely are unobstructed. Since this space is a logarithmically \'etale cover of $\VZ_{1,\alpha}(\mathbb P_{\mathrm{log}},d)$, logarithmic smoothness of the latter follows.

The logarithmic multiplicative group $\mathbb G_{\mathrm{log}}$ acts on $\VZ_{1,\alpha}(\mathbb P_{\mathrm{log}},d)$ by translation. Tautologically, $\VZ_{1,\alpha}(\mathbb P_{\mathrm{log}},d)$ is a $\mathbb G_{\mathrm{log}}$-torsor over the moduli problem of maps up to this $\mathbb G_{\mathrm{log}}$ translation. It is representable after a logarithmically \'etale modification by a family of nodal curves. It follows that the space $\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P_{\mathrm{log}},d)$ of maps up to $\Glog$-translation that factorise completely is logarithmically smooth. 

To conclude the \DIFdelbegin \DIFdel{main }\DIFdelend result, we compare \DIFdelbegin \DIFdel{the stacks }\DIFdelend $\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P_{\mathrm{log}},d)$ and  $\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P|H_0+H_\infty,d)$. Since a map to $(\mathbb P,H_0+H_\infty)$ gives rise immediately to a map to $\mathbb P_{\mathrm{log}}$, there is a morphism
\[
\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P|H_0+H_\infty,d)\to \VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P_{\mathrm{log}},d).
\]
\DIFdelbegin \DIFdel{An application of the infinitesimal }\DIFdelend \DIFaddbegin \DIFadd{The }\DIFaddend lifting criterion shows that this map is logarithmically \'etale, so the result follows.
\end{proof}

\subsection{\DIFdelbegin \DIFdel{Virtual construction for very ample }\DIFdelend \DIFaddbegin \DIFadd{Hypersurface }\DIFaddend pairs}\label{subsection virtual}
\DIFdelbegin \DIFdel{Now let }\DIFdelend \DIFaddbegin \DIFadd{Let }\DIFaddend $(X,Y)$ be a smooth pair with $Y$ very ample. The definition \DIFdelbegin \DIFdel{given }\DIFdelend in \S \ref{subsection factorisation} applies in this setting \DIFdelbegin \DIFdel{, producing }\DIFdelend \DIFaddbegin \DIFadd{and yields }\DIFaddend a moduli space $\VZ_{1,\alpha}(X|Y,\beta)$ \DIFdelbegin \DIFdel{together }\DIFdelend with a morphism
\begin{equation*} \VZ_{1,\alpha}(X|Y,\beta) \to \ol\Mcal^{\operatorname{log}}_{1,\alpha}(X|Y,\beta)\end{equation*}
obtained by performing a logarithmic modification and \DIFdelbegin \DIFdel{then }\DIFdelend passing to a closed substack \DIFaddbegin \DIFadd{where the factorization property is satisfied}\DIFaddend . This moduli space will \DIFdelbegin \DIFdel{not in general be logarithmically smooth}\DIFdelend \DIFaddbegin \DIFadd{typically be non-equidimensional}\DIFaddend , but we \DIFdelbegin \DIFdel{may }\DIFdelend equip it with a virtual class as follows. The \DIFdelbegin \DIFdel{complete linear system $|\OO_X(Y)|$ }\DIFdelend \DIFaddbegin \DIFadd{divisor $Y$ }\DIFaddend defines an embedding $X \hookrightarrow \PP^N$ with $Y=X\cap H$ for $H$ \DIFdelbegin \DIFdel{some }\DIFdelend \DIFaddbegin \DIFadd{a }\DIFaddend hyperplane.

\begin{lemma} The following square is cartesian \DIFdelbegin \DIFdel{(}\DIFdelend in the category of ordinary stacks\DIFdelbegin \DIFdel{)}\DIFdelend :
\bcd
\VZ_{1,\alpha}(X|Y,\beta) \ar[r] \ar[d] \ar[rd,phantom,"\square"] & \VZ_{1,\alpha}(\PP^N|H,d) \ar[d] \\
\VZ_{1,n}(X,\beta) \ar[r,"i"] & \VZ_{1,n}(\PP^N,d).
\ecd
\end{lemma}
\begin{proof} It is clear from the modular description that this square is cartesian in the category of fs logarithmic stacks\DIFdelbegin \DIFdel{. But the morphism }\DIFdelend \DIFaddbegin \DIFadd{, and since }\DIFaddend $i$ is strict, \DIFdelbegin \DIFdel{which implies that the square }\DIFdelend \DIFaddbegin \DIFadd{it }\DIFaddend is also cartesian in \DIFdelbegin \DIFdel{the category of coherent logarithmic stacks.Since fibre products in the latter category are compatible with the functor forgetting logarithmic structures, the claim follows.}\DIFdelend \DIFaddbegin \DIFadd{ordinary stacks.}\DIFaddend \end{proof}

Since $\VZ_{1,n}(\PP^N,d)$ is smooth and $\VZ_{1,n}(X,\beta)$ carries a natural virtual class \cite[Theorem 4.4.1]{RSPW}\DIFdelbegin \DIFdel{there is a diagonal pull-back morphism}\DIFdelend \DIFaddbegin \DIFadd{, the diagonal of $\VZ_{1,n}(\PP^N,d)$ defines a pullback}\DIFaddend ~\cite[Appendix C]{BattistellaNabijou}, \DIFdelbegin \DIFdel{which we use to define }\DIFdelend \DIFaddbegin \DIFadd{and therefore }\DIFaddend the virtual class on the space of maps to $(X,Y)$:
\begin{equation*} \virt{\VZ_{1,\alpha}(X|Y,\beta)} := i_\Delta^! [\VZ_{1,\alpha}(\PP^N|H,d)]. \end{equation*}
\DIFdelbegin \DIFdel{Since }\DIFdelend \DIFaddbegin \DIFadd{Note that this parallel to the virtual formalism in~\mbox{%DIFAUXCMD
\cite{Ga}}%DIFAUXCMD
. As }\DIFaddend $\VZ_{1,\alpha}(X|Y,\beta)$ \DIFdelbegin \DIFdel{comes }\DIFdelend \DIFaddbegin \DIFadd{is }\DIFaddend equipped with evaluation maps and cotangent \DIFdelbegin \DIFdel{line classes, we immediately }\DIFdelend \DIFaddbegin \DIFadd{lines on the universal curve, we }\DIFaddend arrive at a definition of reduced Gromov--Witten invariants for the pair $(X,Y)$ \DIFdelbegin \DIFdel{. This is the same manner in which Gathmann defines his virtual classes~\mbox{%DIFAUXCMD
\cite{Ga}}%DIFAUXCMD
}\DIFdelend \DIFaddbegin \DIFadd{by the standard mechanics}\DIFaddend . 

\section{Stratification and tropicalization}

\noindent The logarithmic \DIFdelbegin \DIFdel{smoothness established in }\DIFdelend \DIFaddbegin \DIFadd{smoothnessof }\DIFaddend Theorem~\ref{thm: log-smoothness} implies that $\VZ_{1,\alpha}(\mathbb P^N|H,d)$ is an orbifold toroidal embedding. \DIFdelbegin \DIFdel{Consequently, the }\DIFdelend \DIFaddbegin \DIFadd{The }\DIFaddend irreducible components of its boundary \DIFdelbegin \DIFdel{and their intersections form a stratification of the space. This stratification will be important in the sequel}\DIFdelend \DIFaddbegin \DIFadd{stratify the space, as we now describe}\DIFaddend .

The tropicalizations of logarithmic maps that factorise completely \DIFdelbegin \DIFdel{satisfy a natural combinatorial }\DIFdelend \DIFaddbegin \DIFadd{are combinatoriall constrained by a }\DIFaddend condition known as \DIFdelbegin \DIFdel{well-spacedness}\DIFdelend \DIFaddbegin \textbf{\DIFadd{well-spacedness}}\DIFaddend . The version we use here is essentially identical to~
\cite{RSPW2}. 

\begin{definition}
Let $\plC$ be a tropical curve of genus one and let $\plC_0$ be its minimal subcurve of genus one. A tropical map $F: \plC\to \mathbb R_{\geq 0}$ is said to be \textbf{well-spaced} if one of the following two conditions are satisfied:
 \begin{enumerate} 
    \item no open neighbourhood of $\plC_0$ is contracted to a point in $\mathbb R_{>0}$, or
    \item if an open neighbourhood of $\plC_0$ is contracted and $t_1,\ldots,t_k$ are the flags whose vertex is mapped to $F(\plC_0)$, but along which $F$ has nonzero slope; then, the minimum of the distances from $\plC_0$ to $t_i$ occurs for at least two indices $i$.
 \end{enumerate} 
\end{definition}

\begin{prop}\label{prop: well-spaced}
Let $[C\to \mathbb P^N]$ be a logarithmic stable map from a centrally aligned curve to an expansion, that factorises completely. Then the tropicalization $\plC\to \mathbb R_{\geq 0}$ is well-spaced.
\end{prop}

\begin{proof}
The required result is essentially contained in~\cite[Section 4]{RSPW2}, so we explain how to deduce the requisite result from the one in loc. cit. We may focus on a single component of the expansion $\mathbb P^N[s]$ that contains the image of a contracted genus one subcurve, as this is the only relevant case. We may thus replace the target with the projective bundle $\mathbb P(\mathcal O(1)\oplus \mathcal O)$ over $\mathbb P^{N-1}$ equipped with the divisorial logarithmic structure from the $0$ and $\infty$ sections. Let $p$ be the point to which the genus one subcurve is contracted. Passing to an open neighbourhood of $p$, the map to the bundle is given by a rational function $f$ on an open curve $C^\circ$, determined by the the subgraph formed by $\plC_0$ and the flags $t_i$ described in the definition above. To describe the tropical map to $\mathbb R_{>0}$, we observe that $\plC_0$ is contracted to a fixed point $q\in\mathbb R_{>0}$. The flags at $t_i$ correspond to nodes or markings of $C$. The pole orders of $f$ at these distinguished points determine the slopes of the tropical map. We are now exactly in the situation considered in~\cite[Second Paragraph of \S~4.6]{RSPW2}, and Lemma~4.6.1 of loc. cit. guarantees the well-spacedness\DIFdelbegin \DIFdel{as required}\DIFdelend .
\end{proof}

\subsection{The cone complex} To understand the stratification via combinatorial data, we will build the stratification from known objects. \\

\noindent
\textbf{Step 1}. Let $\Sigma^{\mathrm{log}}$ be the tropical moduli space of genus one tropical stable maps to $\mathbb R_{\geq 0}$. This is naturally identified with the tropicalization (in the logarithmic sense) of the Abramovich--Chen--Gross--Siebert space of logarithmic stable maps to the pair $(\mathbb P^N,H)$. \\

\noindent
\textbf{Step 2}. Given such a tropical stable map, we may subdivide $\mathbb R_{\geq 0}$ such that the image of every vertex of $\plC$ is a vertex of $\mathbb R_{\geq 0}$. Call this subdivision $\widetilde{\mathbb R}_{\geq 0}$. The preimages of vertices of the subdivision form a subdivision of $\plC$. After this procedure, the images of vertices of $\plC$ which lie in $\RR_{>0}$ are totally ordered, in a manner extending the partial order obtained from the map to $\mathbb R_{\geq 0}$. The combinatorial types of such \textbf{image-ordered} maps produce the cones of a subdivision of $\Sigma^{\mathrm{log}}$ which we denote $\Sigma^{\mathrm{Kim}}$. As the notation suggests, $\Sigma^{\Kim}$ is the tropicalization of Kim's moduli space of logarithmic maps to $(\PP^N,H)$.\\

\noindent
\textbf{Step 3.} Given a tropical map $F: \plC\to \mathbb R_{\geq 0}$ parameterised by $\Sigma^{\mathrm{Kim}}$, there is a largest radius $\delta$ (possibly equal to $0$) such that every vertex strictly contained in the circle of radius $\delta$ around the core has degree-marking $d=0$. Let $
\Sigma^{\mathrm{cen}}$ be the subdivision obtained by requiring that the vertices contained within the circle of radius $\delta$ around the core of $\plC$ are totally ordered. This involves introducing cones along which certain $\Z$-linear combinations of edge lengths are identified.\\

\noindent
\textbf{Step 4}. Let $\Sigma_{1,\alpha}(\mathbb P^N|H,d)$ be the subcomplex of $\Sigma^{\mathrm{cen}}$ consisting of well-spaced tropical maps.

\begin{prop}
The cone complex $
\Sigma_{1,\alpha}(\mathbb P^N|H,d)$ is the fan of the toroidal embedding $
\VZ_{1,\alpha}(\mathbb P^N|H,d)$. In particular, the codimension $k$ strata of $
\VZ_{1,\alpha}(\mathbb P^N|H,d)$ are in inclusion reversing bijection with the dimension $k$ cones in $
\Sigma_{1,\alpha}(\mathbb P^N|H,d)$.
\end{prop}

\begin{proof}
The construction above has been given to mimic the construction of the space $
\VZ_{1,\alpha}(\mathbb P^N|H,d)$. Specifically, the fact that \DIFdelbegin \DIFdel{the cone complex }\DIFdelend $\Sigma^{\mathrm{cen}}$ is the cone complex attached to the logarithmic stack $\widetilde{\VZ}_{1,\alpha}(\mathbb P^N|H,d)$ of centrally aligned maps to expansions, follows \DIFdelbegin \DIFdel{immediately }\DIFdelend from its description as a subcategory of the fibred category (over logarithmic schemes) of $\mathcal M^{\mathrm{log}}_{1,\alpha}(\mathbb P^N|H,d)$. To complete the result, \DIFdelbegin \DIFdel{we }\DIFdelend note that $
\VZ_{1,\alpha}(\mathbb P^N|H,d)$ has a strict map to $
\VZ_{1,\alpha}(\mathbb P^N|H,d)$, so its cone complex is a subcomplex of $\Sigma^{\mathrm{cen}}$. The fact that it \DIFdelbegin \DIFdel{must be }\DIFdelend \DIFaddbegin \DIFadd{is }\DIFaddend contained in the subcomplex of well-spaced curves is immediate from Proposition~\ref{prop: well-spaced}.
\end{proof}

\subsection{Indexing the strata} \label{subsection indexing strata} The dimension-$k$ cones in $\Sigma_{1,\alpha}(\PP^N|H,d)$ can be enumerated as follows. First, the cones in $\Sigma=\Sigma^{\Kim}$ are indexed by \textbf{combinatorial types} of tropical maps to $\RR_{\geq 0}$. Here a combinatorial type encodes all of the data of a tropical map, except for the edge lengths. To be more precise, a combinatorial type $\Delta$ consists of:
 \begin{enumerate} 
\item a finite graph $\sqC$ and topological (not metric) subdivision $\widetilde\RR_{\geq 0}$ of $\RR_{\geq 0}$;
\item genus, degree and marking assignments on the vertices;
\item the data of which vertex of $\widetilde\RR_{\geq 0}$ each vertex of $\sqC$ is mapped to;
\item integral slopes along the edges (both finite and infinite).
 \end{enumerate} 
The corresponding cone $\sigma \in \Sigma^{\operatorname{Kim}}$ is then given by the resulting moduli space of tropical maps, given by choices of edge lengths on source and target which produce a continuous tropical map. Given $\sigma\in \Sigma^{\operatorname{Kim}}$ we then produce all the cones in $\Sigma_{1,\alpha}(\PP^N|H,d)$ mapping to $\sigma$ by performing Steps 3--4 outlined above. This amounts to \DIFdelbegin \DIFdel{taking a particular }\DIFdelend \DIFaddbegin \DIFadd{a }\DIFaddend subdivision of $\sigma$. \DIFdelbegin \DIFdel{Note that in }\DIFdelend \DIFaddbegin \DIFadd{In }\DIFaddend this process, new cones are created which map into larger-dimensional cones of $\Sigma^{\operatorname{Kim}}$. The process for enumerating the codimension $k$ strata of $\VZ_{1,\alpha}(\PP^N|H,d)$ is therefore:
 \begin{enumerate} 
\item fix a combinatorial type $\Delta$;
\item perform the subdivision of the resulting cone $\sigma \in \Sigma^{\operatorname{Kim}}$;
\item identify the dimension $k$ cones of that subdivision.
 \end{enumerate} 
In \S \ref{section reduced splitting} we will perform this analysis in the case $k=1$.


\section{Degeneration of contact order}\label{Section Gathmann line bundle} Consider \DIFdelbegin \DIFdel{a reduced relative }\DIFdelend \DIFaddbegin \DIFadd{the moduli }\DIFaddend space $\VZ_{1,\alpha}(\PP^N|H,d)$ \DIFaddbegin \DIFadd{of relative maps that factorize completely}\DIFaddend . For each marking $x_k$\DIFdelbegin \DIFdel{we }\DIFdelend \DIFaddbegin \DIFadd{, }\DIFaddend consider the locus $\Dcal_{1,\alpha,k}(\PP^N|H,d) \subseteq \VZ_{1,\alpha}(\PP^N|H,d)$ where $x_k$ belongs to an \DIFdelbegin \DIFdel{internal component }\DIFdelend \DIFaddbegin \textbf{\DIFadd{internal component}} \DIFaddend of the collapsed map\DIFaddbegin \DIFadd{, i.e. a component of the curve that is mapped into $H$}\DIFaddend . In this section, we use the logarithmic structure on $\VZ_{1,\alpha}(\PP^N|H,d)$ to construct a line bundle $\Lcal_k$ \DIFdelbegin \DIFdel{together with a }\DIFdelend \DIFaddbegin \DIFadd{and }\DIFaddend section $s_k$ which vanishes precisely along $\Dcal_{1,\alpha,k}(\PP^N|H,d)$. We use the correspondence with tropical geometry to identify $\cchern_1(\Lcal_k)$ in terms of tautological classes on $\VZ_{1,\alpha}(\PP^N|H,d)$, and to compute the vanishing order of $s_k$ along the components of $\Dcal_{1,\alpha,k}(\PP^N|H,d)$. Combined with the relative splitting \DIFdelbegin \DIFdel{axioms established }\DIFdelend \DIFaddbegin \DIFadd{formulas from }\DIFaddend in the next section, we obtain a recursion relation inside $\VZ_{1,\alpha}(\PP^N|H,d)$

The pair $(\Lcal_k,s_k)$ is most naturally constructed on the moduli space $\MLog_{1,\alpha}(\PP^N|H,d)$ of non-expanded logarithmic maps; the corresponding pair on $\VZ_{1,\alpha}(\PP^N|H,d)$ will be obtained via pull-back. Consider therefore the tropicalization $\Sigma^{\log}$ of $\MLog_{1,\alpha}(\PP^N|H,d)$, identified as usual with the moduli space of tropical maps to $\RR_{\geq 0}$. We have a universal family
\bcd
\sqC \ar[d,"\pi"] \ar[r,"f"] & \RR_{\geq 0} \\
\Sigma^{\log} \ar[u, bend left=40pt, "x_k" left]
\ecd
where $x_k$ is the section which for every point $\lambda \in \Sigma^{\log}$ picks out the vertex of $\sqC_\lambda$ containing the leg $x_k$. The composition $f \circ x_k \colon \Sigma^{\log} \to \RR_{\geq 0}$ defines a piecewise-linear function on $\Sigma^{\log}$ whose preimage over the open cone $\RR_{>0}$ consists of those tropical maps where $x_k$ belongs to an internal component. This produces a section of the ghost sheaf on $\MLog_{1,\alpha}(\PP^N|H,d)$, which in the usual way induces a line bundle and section $(\Lcal_k,s_k)$ on the moduli space, and the tropical description above shows that the zero locus of $s_k$ is (set-theoretically) the locus where $x_k$ belongs to an internal component.\medskip

We now calculate $\cchern_1(\Lcal_k)$. 
\begin{thm} $\cchern_1(\Lcal_k) = \alpha_k \psi_k + \ev_k^\st H.$\end{thm}
\begin{proof}
Choose a family of logarithmic stable maps over $S$ and let $\mu \in \Gamma(S,\ol{M}_S)$ be the global section of the ghost sheaf constructed in the previous paragraph. This pulls back along $\pi$ to give a global section $\pi^\flat(\mu) \in \Gamma(C,\ol{M}_C)$.  Interpreted as a piecewise-linear function on the tropicalization $\sqC$ with values in $\ol{M}_S$ \cite[Remark 7.3]{CavalieriChanUlirschWise}, this assigns $\mu$ to every vertex and has slope zero along every edge. By construction, the line bundle associated to this section is $\pi^\st \Lcal_k$. Consider on the other hand the generator $1 \in \N = \Gamma(\PP^N,\ol{M}_{\PP^N})$ with associated line bundle $\OO(H)$. The section $f^\flat(1) \in \Gamma(C,\ol{M}_C)$ has associated line bundle $f^\st\OO(H)$. If we let $v$ denote the vertex containing $x_k$, then by construction $f^\flat(1)$ assigns $\mu$ to $v$ and has slope $\alpha_k$ along the leg $x_k$. Thus if we consider the difference $f^\flat(1) - \pi^\flat(\mu)$ then this assigns $0$ to $v$ and still has slope $\alpha_k$ along $x_k$. Thus by \cite[Proposition 2.4.1]{RSPW} the corresponding line bundle restricted to $C_v$ is given by
\begin{equation*} \OO_{C_v} \left(\alpha_k x_k + \sum_e \mu_e x_e \right) \end{equation*}
where the sum is over the edges $e$ adjacent to $v$ and distinct from $x_k$. Thus we have:
\begin{equation*} \left( f^\st\OO(H) \otimes \pi^\st \Lcal_k^{-1} \right) \big|_{C_v} = \OO_{C_v} \left(\alpha_k x_k + \sum_e \mu_e x_e \right).\end{equation*}
Since $x_k$ factors through $C_v$ we may pull back along $x_k$ to obtain
\begin{equation*} \Lcal_k = x_k^\st\pi^\st \Lcal_k = x_k^\st \OO_{C_k}(-\alpha_k x_k) \otimes x_k^\st f^\st\OO(H) = x_k^\st \OO_{C_k}(-\alpha_k x_k) \otimes \ev_k^\st \OO(H) \end{equation*}
and taking Chern classes gives
\begin{equation*} \cchern_1(\Lcal_k) = \alpha_k \psi_k + \ev_k^\st H\DIFdelbegin \DIFdel{.}\DIFdelend \DIFaddbegin \DIFadd{,}\DIFaddend \end{equation*}
as required.\end{proof}
This \DIFdelbegin \DIFdel{gives the construction of }\DIFdelend \DIFaddbegin \DIFadd{produces }\DIFaddend $(\Lcal_k,s_k)$ and \DIFdelbegin \DIFdel{the calculation of }\DIFdelend \DIFaddbegin \DIFadd{calculates }\DIFaddend $\cchern_1(\Lcal_k)$ on $\MLog_{1,\alpha}(\PP^N|H,d)$; \DIFdelbegin \DIFdel{the construction on $\VZ_{1,\alpha}(\PP^N|H,d)$ is given by pull-back}\DIFdelend \DIFaddbegin \DIFadd{this bundle is pulled back to $\VZ_{1,\alpha}(\PP^N|H,d)$}\DIFaddend . The relevant piecewise-linear function is the composition:
\begin{equation*} \Sigma_{1,\alpha}(\PP^N|H,d) \to \Sigma^{\log} \to \RR_{\geq 0}.\end{equation*}
\DIFdelbegin \DIFdel{In particular, }\DIFdelend \DIFaddbegin \DIFadd{Note that }\DIFaddend $\psi_k$ should be interpreted as a \textbf{collapsed \DIFdelbegin \DIFdel{psi }\DIFdelend class} on $\VZ_{1,\alpha}(\PP^N|H,d)$, i.e. \DIFdelbegin \DIFdel{a psi class coming from the stabilised }\DIFdelend \DIFaddbegin \DIFadd{the cotangent class from the source }\DIFaddend curve of the collapsed \DIFdelbegin \DIFdel{map. In this paper, all psi classes are collapsed unless stated otherwise. We immediately arrive at :
}\DIFdelend \DIFaddbegin \DIFadd{and stabilised map. We arrive at the the recursion. 
}\DIFaddend 

\begin{thm} \label{theorem recursion} We have the following relation in the Chow ring of $\VZ_{1,\alpha}(\PP^N|H,d)$:
\begin{equation}\label{equation recursion} (\alpha_k \psi_k + \ev_k^\st H) \cap [\VZ_{1,\alpha}(\PP^N|H,d)] = \sum_{\Dcal} \lambda_\Dcal [ \Dcal ].\end{equation}
The sum is over irreducible components of the divisor $\Dcal_{1,\alpha,k}(\PP^N|H,d) \subseteq \VZ_{1,\alpha}(\PP^N|H,d)$, and $\lambda_\Dcal$ is the vanishing order of $s_k$ along this component. \end{thm}

\begin{remark} This construction gives the natural logarithmic analogue of Gathmann's line bundle and section \cite[Construction 2.1]{Ga}. A benefit of the logarithmic approach is to make the computation of vanishing orders entirely combinatorial (see \S \ref{subsubsection splitting degree} below), circumventing the difficult technical calculation given by Gathmann. \end{remark}

\section{Splitting the boundary}\label{section reduced splitting}

A basic phenomenon is responsible for the nature of the forthcoming analysis. In contrast with nodal singularities, the functions on an elliptic singularity are not simply \DIFdelbegin \DIFdel{given as }\DIFdelend collections of functions on the normalisation \DIFdelbegin \DIFdel{subject to topological gluing conditions. As a consequence, in }\DIFdelend \DIFaddbegin \DIFadd{that agree at the gluing point. In }\DIFaddend order to compute integrals, it is necessary to give a tautological description of this additional \DIFdelbegin \DIFdel{factorisation condition }\DIFdelend \DIFaddbegin \DIFadd{condition that captures which functions (or maps) descend from the normalization to the singularity}\DIFaddend . 

\DIFdelbegin \DIFdel{In what follows, we }\DIFdelend \DIFaddbegin \DIFadd{We }\DIFaddend provide an explicit description of the terms appearing in the right-hand side of \eqref{equation recursion}.  For each term, we provide a combinatorial formula for the vanishing order $\lambda_\Dcal$, and a recursive description of the stratum $\Dcal$. 
in terms of fibre products of moduli spaces with smaller numerical data. The tautological description of the factorisation condition then leads to a recursive structure for calculating integrals. This \DIFdelbegin \DIFdel{last }\DIFdelend step is the heart of the analysis. 

\begin{remark}
\DIFdelbegin \DIFdel{We remark that for the reduced relative }\DIFdelend \DIFaddbegin \DIFadd{The reduced relative Gromov--Witten }\DIFaddend theory of $(\mathbb P^N,H)$ with only primary \DIFdelbegin \DIFdel{fields, }\DIFdelend \DIFaddbegin \DIFadd{insertions, i.e. where all cohomological insertions in the invariants are pulled back along evaluation maps, computations can be carried out without }\DIFaddend an analysis of the factorisation condition\DIFdelbegin \DIFdel{can be avoided by dimension considerations . This }\DIFdelend \DIFaddbegin \DIFadd{; this follows from dimension considerations and }\DIFaddend leads to the main results in~\cite{Vre}. In order to add descendant \DIFdelbegin \DIFdel{fields}\DIFdelend \DIFaddbegin \DIFadd{insertions}\DIFaddend , study with more general pairs, or indeed work cycle theoretically, an analysis of these tautological classes is crucial. 
\end{remark}

\subsection{Irreducible components of the degenerate locus} We explain the tropical \DIFdelbegin \DIFdel{geometric }\DIFdelend procedure to identify irreducible components of $\Dcal_{1,\alpha,k}(\PP^N|H,d)$.

\begin{lemma} \label{Lemma components are logarithmic divisors} Every irreducible component of $\Dcal_{1,\alpha,k}(\PP^N|H,d)$ is a codimension $1$ logarithmic stratum.\end{lemma}

\begin{proof} The locus where the logarithmic structure is trivial \DIFdelbegin \DIFdel{coincides precisely with }\DIFdelend \DIFaddbegin \DIFadd{is }\DIFaddend the  locus where the source curve is smooth, and \DIFdelbegin \DIFdel{consequently }\DIFdelend \DIFaddbegin \DIFadd{thus }\DIFaddend not mapped inside $H$. Since $\VZ_{1,\alpha}(\PP^N|H,d)$ is toroidal this locus is open and dense. By definition $\Dcal_{1,\alpha,k}(\PP^N|H,d)$ is contained in the  complement of this locus and can be expressed as a union of strata of positive codimension. Since $\Dcal_{1,\alpha,k}(\PP^N|H,d)$ has codimension $1$, it \DIFdelbegin \DIFdel{must therefore be equal to }\DIFdelend \DIFaddbegin \DIFadd{is }\DIFaddend a union of logarithmic divisors.\end{proof}

In \S \ref{subsection indexing strata} we \DIFdelbegin \DIFdel{discussed how to enumerate }\DIFdelend \DIFaddbegin \DIFadd{described }\DIFaddend the logarithmic strata of $\VZ_{1,\alpha}(\PP^N|H,d)$, using the cones of the tropicalization $\Sigma_{1,\alpha}(\PP^N|H,d)$. Every divisorial logarithmic stratum is obtained as follows:
 \begin{enumerate} 
\item choose a combinatorial type $\Delta$ of a tropical map;
\item subdivide the corresponding tropical moduli space $\sigma$ to align the type;
\item choose a ray in this subdivision.
 \end{enumerate} 
This process contains \DIFdelbegin \DIFdel{some }\DIFdelend redundancies: upon choosing a ray in the tropical moduli space, some of the edge lengths or vertex positions may get set to $0$. This induces a generisation of the initial combinatorial type $\Delta$, given by contracting the corresponding edges of the dual graph and moving the corresponding vertices from $\RR_{>0}$ to $0$. When we speak of the combinatorial type of a stratum in $\VZ_{1,\alpha}(\PP^N|H,d)$, we will always mean this generisation. This is independent of the choice of $\Delta$, and in fact we can and will always choose $\Delta$ to coincide with the generisation.

The logarithmic divisors contained in $\Dcal_{1,\alpha,k}(\PP^N|H,d)$ are \DIFdelbegin \DIFdel{precisely }\DIFdelend those whose  combinatorial types map the vertex of the dual graph containing $x_k$  into the interior $\RR_{>0} \subseteq \RR_{\geq 0}$. Thus via the above procedure, we enumerate the \DIFdelbegin \DIFdel{irreducible }\DIFdelend components of $\Dcal_{1,\alpha,k}(\PP^N|H,d)$ in a combinatorial manner\DIFdelbegin \DIFdel{, and }\DIFdelend \DIFaddbegin \DIFadd{; }\DIFaddend the combinatorial type $\Delta$ allows us to describe the general element of such a component. The remainder of this section gives a recursive description of the components \DIFdelbegin \DIFdel{, and a procedure to compute }\DIFdelend \DIFaddbegin \DIFadd{and a recursive computation of }\DIFaddend integrals over them\DIFdelbegin \DIFdel{in a recursive manner}\DIFdelend .

\subsection{Recursive description of the divisors: types I,II and III} Choose an irreducible component $\Dcal \subseteq \Dcal_{1,\alpha,k}(\PP^N|H,d)$. By Lemma \ref{Lemma components are logarithmic divisors} this is a logarithmic divisor, and hence may be written as:
\begin{equation*} \Dcal = \widetilde\Dcal \cap \VZ_{1,\alpha}(\PP^N|H,d) \end{equation*}
for a unique logarithmic stratum $\widetilde\Dcal \subseteq \widetilde{\VZ}_{1,\alpha}(\PP^N|H,d)$. Since
\begin{equation*}\widetilde{\VZ}_{1,\alpha}(\PP^N|H,d) \to \ol\Mcal_{1,\alpha}(\PP^N|H,d)\end{equation*}
is a logarithmic modification, the divisor $\widetilde{\Dcal}$ is either exceptional or the strict transform of a logarithmic divisor. These two cases correspond, respectively, to when the core is assigned zero degree or nonzero degree by the combinatorial type. \DIFdelbegin \DIFdel{To begin with we will focus on the lattercase}\DIFdelend \DIFaddbegin \DIFadd{We begin with the latter}\DIFaddend . Suppose therefore that $\widetilde{\Dcal}$ is the proper transform of a logarithmic divisor:
\begin{equation*} \Ecal \subseteq \ol\Mcal_{1,\alpha}(\PP^N|H,d). \end{equation*}
The birational map $\widetilde{\Dcal} \to \Ecal$ induces a morphism $\Dcal \to \Ecal$. We now show how to interpret this morphism as a desingularisation of the principal component. Since $\Ecal$ admits a recursive description in terms of relative and rubber moduli spaces, this will allow us to compute integrals over $\Dcal$.

\begin{lemma}\label{lem:combs} Let $\Dcal \subseteq \Dcal_{1,\alpha,k}(\PP^N|H,d)$ be an irreducible component which contributes nontrivially to the Gromov--Witten invariant, and let $\Delta$ be the corresponding combinatorial type. \DIFdelbegin \DIFdel{Suppose that }\DIFdelend \DIFaddbegin \DIFadd{If }\DIFaddend $\Delta$ assigns positive degree to the core\DIFdelbegin \DIFdel{. Then }\DIFdelend \DIFaddbegin \DIFadd{, then }\DIFaddend $\Delta$ takes one of the following forms:
\begin{figure}[h]
    \centering
    \begin{minipage}{0.3\textwidth}
        \centering
        \Yagraph
        \caption{I}
    \end{minipage}\hfill
    \begin{minipage}{0.3\textwidth}
        \centering
        \Ybgraph
        \caption{II}
    \end{minipage}\hfill
    \begin{minipage}{0.3\textwidth}
        \centering
        \Ycgraph
        \caption{III}
    \end{minipage}
\end{figure}

\noindent The degrees of vertices, expansions factors, and remaining markings are distributed arbitrarily, subject to the following constraints:
 \begin{enumerate} 
\item the vertices $\sqC_1,\ldots,\sqC_r$ have positive degree;
\item the core has positive degree;
\item every vertex is stable;
\item the balancing condition is satisfied.
 \end{enumerate} \end{lemma}
In \cite{Vre} these cases are referred to, respectively, as types $A,B$ and $C^+$.

\begin{proof} Let $\sigma \in \Sigma_{1,\alpha}(\PP^N|H,d)$ be the cone corresponding to the $\Ecal \subseteq \ol\Mcal_{1,\alpha}(\PP^N|H,d)$. By the discussion above $\Dcal$ corresponds to a ray in the subdivision of $\sigma$ given by imposing the central alignment condition. Since the elliptic core is assigned positive degree, both radii are equal to $0$ and the subdivision is trivial. We conclude that $\sigma=\RR_{\geq 0}$. Since there must be at least one vertex mapped to higher level, the tropical target $\widetilde\RR_{\geq 0}$ is obtained from $\RR_{\geq 0}$ by subdividing at a single point $\diamond \in \RR_{> 0}$.

In order for the cone $\sigma$ to be $1$-dimensional, the dual graph $\Gamma$ must be bipartite, with vertices over $0$ and $\diamond$. The cases I,II and III enumerated above cover situations where there is a single vertex mapped to $\diamond$. If there is more than one such vertex, then the contribution to the Gromov--Witten invariant vanishes. To see this, we consider the stratum
\begin{equation*} \Ecal^{\text{\tiny{log}}} \subseteq \ol\Mcal^{\text{\tiny{log}}}_{1,\alpha}(\PP^N|H,d) \end{equation*}
to which $\Ecal$ maps under the collapsing morphism, and examine the composition $\Dcal \to \Ecal \to \Ecal^{\text{\tiny{log}}}$. If we let $\Fcal^{\text{\tiny{log}}}$ denote the intersection of $\Ecal^{\text{\tiny{log}}}$ with the main component of the moduli space, then we obtain a factorisation $\Dcal \to \Fcal^{\text{\tiny{log}}} \hookrightarrow \Ecal^{\text{\tiny{log}}}$. Since the moduli space is generically unobstructed along $\Fcal^{\text{\tiny{log}}}$, the codimension of $\Fcal^{\text{\tiny{log}}}$ is given by the dimension of the associated cone in the tropicalization $\Sigma^{\text{\tiny{log}}}$. If there is more than one vertex mapped to higher level, then this cone has dimension $\geq 2$. Therefore the map $\Dcal \to \Fcal^{\text{\tiny{log}}}$ has positive-dimensional fibres, and since all insertions are pulled back from the latter space the contribution vanishes by the projection formula.\end{proof}

\begin{remark} The difference in dimensions between $\Dcal$ and $\Fcal^{\text{\tiny{log}}}$ (or equivalently, \DIFdelbegin \DIFdel{the difference in virtual dimensions between }\DIFdelend \DIFaddbegin \DIFadd{between virtual dimensions of }\DIFaddend $\Ecal$ and $\Ecal^{\text{\tiny{log}}}$) may be interpreted as the difference in dimensions between moduli spaces of \emph{disconnected} rubber and their images under the collapsing morphisms. \end{remark}

We now investigate the three types I, II and III separately, giving a recursive description of the boundary divisor in each case. For the remainder of this subsection, therefore, we fix a one-dimensional cone $\tau \in \Sigma_{1,\alpha}(\PP^N|H,d)$, let $\Dcal \subseteq \VZ_{1,\alpha}(\PP^N|H,d)$ be the associated logarithmic divisor, and assume that $\Dcal$ is contained in $\Dcal_{1,\alpha,k}(\PP^N|H,d)$ and is of type I, II or III. We let $\Ecal \subseteq \ol\Mcal_{1,\alpha}(\PP^N|H,d)$ be the logarithmic stratum into which $\Dcal$ is mapped; this is indexed by a cone $\epsilon \in \Sigma^{\Kim}$ corresponding to a combinatorial type $\Delta$, and $\epsilon$ is one-dimensional since we are restricting to the type I,II,III cases.


\subsubsection{Type I}\label{subsubsection type A} Suppose $\Delta$ is of type I. Then $\Ecal$ admits a finite and surjective \DIFdelbegin \textit{\DIFdel{splitting morphism}} %DIFAUXCMD
\DIFdelend \DIFaddbegin \textbf{\DIFadd{splitting morphism}} \DIFaddend onto the fibre product:
\begin{equation*} \Ecal \to \left( \ol\Mcal_{1,\alpha^{(1)}\cup(m_1)}(\PP^N|H,d_1) \times \prod_{i=2}^r \ol\Mcal_{0,\alpha^{(i)}\cup(m_i)}(\PP^N|H,d_i) \right) \times_{H^r} \ol\Mcal^{\leftrightarrow}_{0,\alpha^{(0)}\cup (-m_1,\ldots,-m_r)}(\mathbb{P}|H_0+H_\infty,d_0).\end{equation*}

\begin{lemma} \label{Lemma type A gluing} The divisor $\Dcal$ admits a natural splitting morphism
\begin{equation*}\Dcal \xrightarrow{\rho} \left(\VZ_{1,\alpha^{(1)}\cup(m_1)}(\PP^N|H,d_1)\times\prod_{i=2}^r \ol\Mcal_{0,\alpha^{(i)}\cup(m_i)}(\PP^N|H,d_i)\right) \times_{H^r} \ol\Mcal^{\leftrightarrow}_{0,\alpha^{(0)}\cup (-m_1,\ldots,-m_r)}(\mathbb{P}|H_0+H_\infty,d_0)\end{equation*}
such that the map $\Dcal \to \Ecal$ covers the map on fibre products obtained by desingularising the main component of the factor corresponding to $\sqC_1$.\end{lemma}

\begin{proof}
We first consider the statement of the lemma in the category of fine but not necessarily saturated logarithmic schemes, so that a relative stable map to an expansion admits a unique logarithmic lifting. The fibre product description preceding the lemma is an isomorphism in this category~\cite[Lemma~4.2.2]{AbramovichMarcusWiseComparison}.

The map $\Dcal\to\Ecal$ is an isomorphism away from the exceptional centres, and the latter is contained in the locus where the core is contracted. Given an element of $\Dcal$ we can split it along the nodes $q_1,\ldots,q_r$. It is then clear that $\sqC_1$ is aligned. We claim that $\sqC$ satisfies the factorisation property if and only if $\sqC_1$ does. This immediately implies the lemma.

On $\sqC$ there are two contraction radii $\delta_F,\delta_B$. Let $\delta \in \{\delta_F,\delta_B\}$. An examination of the stratification by combinatorial type of $\Dcal$ shows that $\lambda(\sqC^\prime) > \delta$ for any component $\sqC^\prime$ of $\sqC_0$. This means that $\sqC_0,\sqC_2,\sqC_3,\ldots,\sqC_r$ lie outside both contraction radii, and so the aligned curve $\sqC$ satisfies the factorisation condition if and only if $\sqC_1$ does. \end{proof}

%\begin{lemma}\label{type A radius lemma} In the notation of the proof above, $\lambda(\sqC^\prime) > \delta$ for any component $\sqC^\prime$ of $\sqC_0$.\end{lemma}
%
%\begin{proof} Observe first that $\Dcal$ is obtained as the disjoint union of the locally closed logarithmic strata contained in the closure of the stratum where all of the $\sqC_i$ are irreducible. We choose and examine one of these boundary strataIf we look at one of these boundary strata, then by definition the associated cone $\sigma \in \Sigma_{1,\alpha}(\PP^N|H,d)$ contains a ray $\tau$ corresponding to the stratum where all the $\sqC_i$ are irreducible; this amounts to setting all edge lengths other than $e_1,\ldots,e_r$ to zero. If $f_1,\ldots,f_l$ are some collection of additional edge lengths in $\sigma$ (corresponding to internal nodes in degenerations of the $\sqC_i$) then since $\sigma$ is adjacent to $\tau$ we must have (by construction of the subdivision) $f_1+\ldots+f_l < e_j$ for all $j\in\{1,\ldots,r\}$, since $f_1=\ldots=f_l=0$ and $e_j \neq 0$ on $\tau$. In particular, if $\sqC_1$ is degenerate and if $\delta$ denotes the minimal distance from the core to a non-contracted vertex of $\sqC_1$ (which certainly exists since $\sqC_1$ has positive degree) then $\delta < e_1 \leq \lambda(\sqC^\prime)$, as claimed.\end{proof}

Lemma \ref{Lemma type A gluing} provides a means to calculate integrals over the class $\lambda_\Dcal[\Dcal]$ appearing on the right-hand side of Theorem \ref{theorem recursion}, provided that we can calculate $\lambda_\Dcal$ and the degree of the splitting morphism. Simple closed formulae for these are given in \S \ref{subsubsection splitting degree} below.

\subsubsection{Type II}
Now suppose $\Delta$ is of type II. \DIFdelbegin \DIFdel{Note that in }\DIFdelend \DIFaddbegin \DIFadd{In }\DIFaddend this case, it is impossible for the core to be contracted. Hence $\Ecal$ is disjoint from the blown-up locus, and the map $\Dcal \to \Ecal$ is an isomorphism. We \DIFdelbegin \DIFdel{thus }\DIFdelend obtain the following description, entirely in terms of genus zero data:
\begin{lemma} $\Dcal$ admits a finite and surjective splitting morphism:
\begin{equation*} \Dcal \xrightarrow{\rho} \left(\ol\Mcal_{0,\alpha^{(1)}\cup(m_1,m_2)}(\PP^N|H,d_1)\times\prod_{i=3}^r \ol\Mcal_{0,\alpha^{(i)}\cup(m_i)}(\PP^N|H,d_i)\right) \times_{H^r} \ol\Mcal^{\leftrightarrow}_{0,\alpha^{(0)}\cup(-m_1,\ldots,-m_r)}(\mathbb P|H_0+H_\infty,d_0).\end{equation*}\end{lemma}

\subsubsection{Type III} \label{subsubsection type C+} Finally suppose that $\Delta$ is of type III. As before we have a finite and surjective morphism:
\begin{equation*} \Ecal \to  \left( \prod_{i=1}^r \ol\Mcal_{0,\alpha^{(i)}\cup(m_i)}(\PP^N|H,d_i) \right) \times_{H^r} \ol\Mcal^{\leftrightarrow}_{1,\alpha^{(0)}\cup(-m_1,\ldots,-m_r)}(\mathbb{P}|H_0+H_\infty,d_0). \end{equation*}
The same arguments as in \S \ref{subsubsection type A} then apply to give:
\begin{lemma} $\Dcal$ admits a finite splitting morphism
\begin{equation*}\Dcal \xrightarrow{\rho} \left( \prod_{i=1}^r \ol\Mcal_{0,\alpha^{(i)}\cup(m_i)}(\PP^N|H,d_i) \right) \times_{H^r} \VZ^{\leftrightarrow}_{1,\alpha^{(0)}\cup(-m_1,\ldots,-m_r)}(\mathbb{P}|H_0+H_\infty,d_0)\end{equation*}
such that $\Dcal \to \Ecal$ corresponds to the obvious map on fibre products.\end{lemma}
\DIFdelbegin \DIFdel{Here the }\DIFdelend \DIFaddbegin \DIFadd{The }\DIFaddend first factor in the fibre product is the logarithmic \DIFdelbegin \DIFdel{blow-up }\DIFdelend \DIFaddbegin \DIFadd{blowup }\DIFaddend of the moduli space of rubber maps constructed in \S \ref{subsection rubber}. We \DIFdelbegin \DIFdel{will }\DIFdelend compute integrals over such spaces as part of the recursion (see \S \ref{section recursion algorithm}).

\subsubsection{Splitting degree and vanishing order} \label{subsubsection splitting degree} In each of the subsections \ref{subsubsection type A}--\ref{subsubsection type C+} above, we obtained a finite splitting morphism $\rho$ from $\Dcal$ to a fibre product of moduli spaces with smaller numerical data. Here we describe the degree of $\rho$ and calculate the vanishing order $\lambda_\Dcal$ of the section $s_k$ constructed in \S \ref{Section Gathmann line bundle}. This gives a complete recursive description of the terms appearing on the right-hand side of Theorem \ref{theorem recursion} which are of type I,II or III.

\begin{lemma}\label{lem:saturation} The degree of $\rho$ is given by:
\begin{equation*} \label{degree of gluing} \dfrac{\prod_{i=1}^r m_i}{\lcm(m_1,\ldots,m_r)}. \end{equation*}\end{lemma}
\begin{proof} The calculation is well known, \DIFdelbegin \DIFdel{and is recorded for instancein}\DIFdelend \DIFaddbegin \DIFadd{see for instance}\DIFaddend ~\cite[Section~7.9]{ChenDegeneration}, \cite[Section~5.3]{ACGSDecomposition}.
\end{proof}

\begin{lemma}\label{lemma vanishing order} The section $s_k$ vanishes along the divisor $\Dcal$ with order given by 
\[
\lambda_\Dcal = \lcm(m_1,\ldots,m_r).
\] 
\end{lemma}
\begin{proof} Let $\tau \in \Sigma_{1,\alpha}(\PP^N|H,d)$ be the cone corresponding to $\Dcal$ and let
\begin{equation*} \varphi \colon \Sigma_{1,\alpha}(\PP^N|H,d) \to \Sigma^{\log} \to \RR_{\geq 0} \end{equation*}
be the piecewise-linear function constructed in \S \ref{Section Gathmann line bundle}. It follows from the tropical description that $\lambda_\Dcal$ is equal to the index of the map of integral cones $\tau \to \RR_{\geq 0}$ obtained by restricting $\varphi$. Observe that $\tau \subseteq \RR_{\geq 0}^r$ with integral generator:
\begin{equation*} w = \left( \dfrac{\lcm(m_1,\ldots,m_r)}{m_1},\ldots,\dfrac{\lcm(m_1,\ldots,m_r)}{m_r} \right).\end{equation*}
The map $\tau \to \RR_{\geq 0}$ is given by projecting onto the $i$th factor and then multiplying by $m_i$. Note that by piecewise linear continuity of the tropical map, this is independent of $i$. We conclude that the index is equal to $\lcm(m_1,\ldots,m_r)$ as claimed.\end{proof}

We summarise that the contribution of each term $\lambda_\Dcal [\Dcal]$ is given by integrating over the appropriate fibre product and then multiplying the result by $\lambda_\Dcal \cdot \deg\rho = \prod_{i=1}^r m_i$.

\subsection{Recursive description of the divisors: type $\dag$}\label{subsection C0 splitting} The treatment of the type I, II and III cases above is a fairly straightforward extension of the ideas of Vakil and Gathmann (albeit updated with logarithmic and tropical technology, which streamlines the presentation and simplifies the proofs). The remaining type $\dag$ case, however, is entirely new. In this section we provide a recursive description of these boundary divisors. This constitutes the technical heart of the paper.

\subsubsection{Possible combinatorial types} A boundary divisor $\Dcal \subseteq \Dcal_{1,\alpha,k}(\PP^N|H,d)$ is said to have \textbf{type $\dag$} if the core is assigned degree zero by the combinatorial type. Divisors of this type occur as principal components in compactified torus bundles over strata in the space of relative maps. As a result, their combinatorial types exhibit very degenerate behaviour. Precisely, over the generic point of such a divisor, the target may expand multiple times, and the source tropical curve need not be bipartite with a single interior vertex. We stress once again that such degenerate contributions are at the heart of the reduced theory and cannot be removed.  We begin with the following lemma:
\begin{lemma} \label{lemma type C0 combinatorial types}
Let $\Dcal$ be a locus of type $\dag$ with combinatorial type $\Delta$ which contributes nontrivially to the Gromov--Witten invariant. For every nonzero vertex $\diamond$ of the tropical target, the fibre of the tropical map over $\diamond$ contains exactly one stable vertex, which either is the core, or lies on the circle. Moreover, the maximal contact order at the core is $m>1$.
\end{lemma}

\begin{proof}
Stability guarantees that at least one stable vertex lies over each vertex of the target. If there is more than one stable vertex, as in the proof of Lemma \ref{lem:combs}, the corresponding locus $\Fcal$ in the moduli space of unexpanded maps has high codimension. As both insertions and the factorisation property for the collapsed map to $\mathbb P^N$ are pulled back from the moduli space of maps without expansions, the contribution vanishes by the projection formula.

For each vertex of the target there must always be at least one vertex in the preimage which lies on the circle. This is implied by the fact that the cone $\tau$ corresponding to $\Dcal$ is a ray. If the vertex on the circle is strictly semistable -- so that in particular the collapsed map $f_B$ is constant along the corresponding component -- it can be seen that the factorisation condition is unaffected by $\Gm$-scaling the coordinate corresponding to that vertex in the moduli space of attaching data, so the map $\Dcal\to\Ecal$ has generic fibre of positive dimension and the contribution vanishes.

In particular, notice that vertices lying on the circle and tropically mapped to $0\in\mathbb R_{\geq0}$ all have the same contact order at the core, because by the previous paragraph we may assume that only strictly semistable vertices are encountered on the paths from these vertices to the core. For the same reason, this contact order $m$ is maximal among those of the edges adjacent to the core.

Finally, in case the maximal contact order is $m=1$, the image tangent vectors must be linearly dependent, in which case we can deduce as above that factorisation will be satisfied independently of the choice of alignment.
\end{proof}
For the remainder of this section we use the following notation for the combinatorial type $\Delta$; we let $\sqC_0$ denotes the vertex of dual graph corresponding to the core, $\sqC_1,\ldots,\sqC_r$ the other stable vertices (genus zero and lying on the circle, by the previous lemma) and $q_1,\ldots,q_r$ the corresponding splitting nodes.


\subsubsection{Recursive description of $\Ecal$} Recall that we have maps
\[
\VZ_{1,\alpha}(\PP^N|H,d)\hookrightarrow \widetilde{\VZ}_{1,\alpha}(\PP^N|H,d)\to \overline\Mcal_{1,\alpha}(\PP^N|H,d).
\]
The first morphism is a closed embedding cut out by the two factorisation properties. The second morphism is a logarithmic modification. Let $\tau \in \Sigma_{1,\alpha}(\PP^N|H,d)$ be the ray corresponding to $\Dcal \subseteq \VZ_{1,\alpha}(\PP^N|H,d)$, and to the virtual divisor $\widetilde \Dcal \subseteq \widetilde{\VZ}_{1,\alpha}(\PP^N|H,d)$. 

Let $\sigma \in \Sigma^{\Kim}$ be the minimal cone containing the image of $\tau$. The dimension of this cone could be large -- its dimension is equal to the the number of levels of the target expansion in the type $\Delta$. The cone $\sigma$ determines a stratum $\Ecal \subseteq \ol\Mcal_{1,\alpha}(\PP^N|H,d)$, and the morphism above restricts to 
\[
\Dcal \to \Ecal.
\] 

\noindent
{\bf Splitting in the ordinary geometry.} The locus $\Ecal$ has the following description. Let $\Lambda_0$ for the collection of stable vertices of the combinatorial type which are mapped to $0\in \RR_{\geq 0}$, and $\Lambda_{>0}$ for the stable vertices which are mapped to $\RR_{>0}$. Each vertex $v$ has associated discrete data $\Gamma_v$. The vertices over $0$ determine moduli spaces of ordinary relative stable maps, while the higher level vertices determine maps to rubber.  Then $\Ecal$ admits a finite and surjective splitting morphism
\begin{equation}\label{IIIa fibre product} \Ecal \xrightarrow{\rho} \left( \prod_{v \in \Lambda_0} \ol\Mcal_{\Gamma_v}(\PP^N|H) \times \prod_{v \in \Lambda_{>0}} \ol\Mcal^{\leftrightarrow}_{\Gamma_v}(\mathbb{P}|H_0+H_\infty) \right) \times_{H^{2\epsilon}} H^{\epsilon} \end{equation}
where $\epsilon$ is the number of edges of the stabilised dual graph, and the fibre product is taken over the appropriate evaluation maps. Splitting the diagonal of $H^{2\epsilon}$ we see that tautological integrals over $\Ecal$ are completely determined in terms of integrals over moduli spaces with ``smaller'' combinatorial data.\medskip

\noindent
{\bf Exportation to the ordinary geometry.}  Observe that we have a virtual divisor $\widetilde\Dcal \subseteq \widetilde\VZ_{1,\alpha}(\PP^N|H,d)$ such that 
\[
\Dcal = \widetilde\Dcal \cap \VZ_{1,\alpha}(\PP^N|H,d).
\]
We wish to use the splitting of $\Ecal$ in the ordinary geometry to recursively compute integrals in the reduced geometry. Noting that $\Dcal$ is cut out of the excess dimensional space $\widetilde \Dcal$ by the factorisation properties, we make the reduction in two steps:
 \begin{enumerate} 
\item in \S \ref{subsection Dtilde from E} we explain how to construct $\widetilde\Dcal$ from $\Ecal$;
\item in \S \ref{subsection D from Dtilde} we explain how to express the class of $\Dcal \subseteq \widetilde\Dcal$ in terms of tautological classes.
 \end{enumerate} 
To compute integrals over $\Dcal$ we simply push down the appropriate classes from $\widetilde\Dcal$ to $\Ecal$ and then integrate over $\Ecal$ using the ordinary splitting axiom.

\begin{remark}[Splitting degree and vanishing order, revisited] Similarly to \S \ref{subsubsection splitting degree} above, we can calculate the degree of $\rho$ and the vanishing order $\lambda_{\Dcal}$ of the section $s_k$ along $\Dcal$. The degree of $\rho$ is given exactly as in Lemma \ref{lem:saturation}, where now we obtain one such factor for each bounded edge of the tropical target. The vanishing order $\lambda_{\Dcal}$ is slightly more delicate, but may be computed as the index of an explicit morphism of one-dimensional lattices, as explained in the proof of Lemma \ref{lemma vanishing order}.
\end{remark}


\subsubsection{Compactified bundles over strata: $\widetilde\Dcal$ from $\Ecal$}\label{subsection Dtilde from E} Recall that the map $\widetilde\Dcal \to \Ecal$ is obtained by restricting the logarithmic \DIFdelbegin \DIFdel{blow-up
}\DIFdelend \DIFaddbegin \DIFadd{blowup
}\DIFaddend \begin{equation*} \widetilde\VZ_{1,\alpha}(\PP^N|H,d) \to \ol\Mcal_{1,\alpha}(\PP^N|H,d)\end{equation*}
to the locus $\widetilde\Dcal$. Toroidal geometry gives a construction of $\widetilde \Dcal$ as a compactification of a torus bundle over a locally closed stratum in $\overline\Mcal_{1,\alpha}(\PP^N|H,d)$. \medskip





%DIF < In toric geometry, the means of studying this restriction is as follows. The fan of $\widetilde\Dcal$ (respectively, $\Ecal$) is obtained by projecting the star of the ray $\tau$ (respectively, the star of the cone $\sigma$) onto the quotient lattice. The map $\widetilde\Dcal \to \Ecal$ is then the toric morphism induced by the obvious map of fans. In order to describe this morphism more explicitly, we first subdivide the fan of $\Ecal$ by taking the images of cones in the fan of $\widetilde\Dcal$. This induces a toric blow-up of $\Ecal$ which we denote by $\widetilde\Ecal$. The morphism $\widetilde\Dcal \to \Ecal$ naturally factors through a morphism $\widetilde\Dcal \to \widetilde\Ecal$ which is now flat (in contrast to $\widetilde\Dcal \to \Ecal$), and  $\widetilde\Dcal$ may now be described as a compactification of a torus bundle over $\widetilde\Ecal$, with strata determined by the combinatorics of the fan.
%DIF > In toric geometry, the means of studying this restriction is as follows. The fan of $\widetilde\Dcal$ (respectively, $\Ecal$) is obtained by projecting the star of the ray $\tau$ (respectively, the star of the cone $\sigma$) onto the quotient lattice. The map $\widetilde\Dcal \to \Ecal$ is then the toric morphism induced by the obvious map of fans. In order to describe this morphism more explicitly, we first subdivide the fan of $\Ecal$ by taking the images of cones in the fan of $\widetilde\Dcal$. This induces a toric blowup of $\Ecal$ which we denote by $\widetilde\Ecal$. The morphism $\widetilde\Dcal \to \Ecal$ naturally factors through a morphism $\widetilde\Dcal \to \widetilde\Ecal$ which is now flat (in contrast to $\widetilde\Dcal \to \Ecal$), and  $\widetilde\Dcal$ may now be described as a compactification of a torus bundle over $\widetilde\Ecal$, with strata determined by the combinatorics of the fan.

\noindent
{\bf Logarithmic structures on strata.} Let $W\subseteq X$ be an irreducible stratum in a toroidal embedding $X$. The stratum \DIFdelbegin \DIFdel{itself is toroidal, and hence }\DIFdelend \DIFaddbegin \DIFadd{$W$ is itself toroidal, or equivalently, when equipped with the divisorial logarithmic structure coming from intersecting with the toroidal boundary divisors of $X$, the resulting structure makes $W$ }\DIFaddend logarithmically smooth. \DIFaddbegin \DIFadd{Note that this differs from the logarithmic structure pulled back from $X$ along the inclusion of $W$ into $X$. 
}

\DIFaddend If $X$ and $W$ are merely logarithmic and not toroidal, there is \DIFdelbegin \DIFdel{nonetheless }\DIFdelend \DIFaddbegin \DIFadd{an analogue of this. There exists }\DIFaddend a strict map
\[
X\to \mathcal A_X,
\]
where $ \mathcal A_X$ is the Artin fan of $X$, which is \DIFdelbegin \DIFdel{a toroidal Artin stack. If $W\subseteq X$ maps to a }\DIFdelend \DIFaddbegin \DIFadd{logarithmically \'etale over a point. The logarithmic structure of $\mathcal A_X$ is divisorial in the smooth topology. The Artin fan $\mathcal A_X$ possesses closed strata. Fix an irreducible }\DIFaddend stratum $\mathcal A_W$\DIFdelbegin \DIFdel{under this map, the pullback of the logarithmic structure from }\DIFdelend \DIFaddbegin \DIFadd{. In identical fashion to the paragraph above, this stack }\DIFaddend $\mathcal A_W$ \DIFdelbegin \DIFdel{to $W$ endows the stratum }\DIFdelend \DIFaddbegin \DIFadd{possesses a logarithmic structure by restricting the divisors on $\mathcal A_X$ and taking the induced logarithmic structure. This equips a logarithmic stratum $W\hookrightarrow X$ }\DIFaddend with a logarithmic structure \DIFdelbegin \DIFdel{. }\DIFdelend \DIFaddbegin \DIFadd{by pullback, mirroring the construction for toroidal embeddings above. 
}

\begin{remark}
\DIFaddend Note that the inclusion of a stratum $W\hookrightarrow X$ is \textit{not} a logarithmic morphism. \DIFaddbegin \DIFadd{The pullback logarithmic structure on a closed stratum includes residual information about the (virtual) normal bundle directions; the construction above effectively removes these directions. Using the equivalence of Artin fans with cone complexes~\mbox{%DIFAUXCMD
\cite{CavalieriChanUlirschWise}}%DIFAUXCMD
, the above construction can be combinatorialised. Given a cone $\sigma$ in a cone stack $\Sigma$, its }\textbf{\DIFadd{star}} \DIFadd{consists of all cones of $\Sigma$ that contain $\sigma$; these naturally form a new cone complex. The associated Artin fan gives rise to the logarithmic structure on $W$ above.
}\end{remark}
\DIFaddend 

Equipped with the strata logarithmic structures, the morphism
\[
\widetilde \Dcal\to \Ecal
\]
is a logarithmic morphism. The generic fibre of this morphism is a toric variety.  \medskip

\noindent
{\bf Flattening the map to $\Ecal$.} The morphism $\widetilde \Dcal\to \Ecal$ is not flat. In order to push integrals forward, it will be convenient to flatten the map by blowing up $\Ecal$. This can be done in a universal manner, following~\cite{AK,Mol16}. 

The combinatorics of the flattening can be described explicitly. Consider the map on tropicalizations
\[
\widetilde{\Dcal}^{\operatorname{trop}} \to \Ecal^{\operatorname{trop}}.
\]
The tropical curves on the left inherit a central alignment from $\widetilde{\VZ}_{1,\alpha}(\PP^N|H,d)$, which orders a certain subset of the edge lengths. The polyhedral criterion for equidimensionality is that every cone of the source maps surjectively onto a cone of the target. There is a universal logarithmic modification $\widetilde\Ecal \to \Ecal$ such that $\widetilde\Dcal \to \widetilde\Ecal$ is flat, constructed by taking the minimal subdivision of $\Ecal^{\operatorname{trop}}$ such that cones map surjectively to cones.

This subdivision is best described using the formalism of extended tropicalizations \cite{Thuillier,ACP}. The subdividing cones are obtained from cones in the star of $\tau$ under the limit $e_1=\cdots=e_r=\infty$. The cones in the star of $\tau$ are given by (in)equalities relating distances of pairs of vertices, and there are three cases to consider:
 \begin{enumerate} 
\item both vertices are components of the subgraph $\sqC \setminus \sqC_0$;
\item both vertices are components of the subgraph $\sqC_0$;
\item one vertex is a component of $\sqC_0$ and one is a component of $\sqC \setminus \sqC_0$.
 \end{enumerate} 
As we pass to the limit, the first relations impose a central alignment condition on the genus zero moduli, the second relations impose a radial alignment condition on the genus one moduli, and the third relations disappear entirely. We are therefore led to the following moduli theoretic description of the logarithmic modification $ \widetilde \Ecal$.

Keeping in mind the fibre product description of $\Ecal$, construct a modification $\widetilde \Ecal$ from $\Ecal$ as follows:
 \begin{enumerate} 
\item Given a logarithmic map of type $\Delta$ with splitting nodes $q_1,\ldots,q_r$, remove the genus one piece $\sqC_0$ and formally glue together the $r$ vertices of the tropicalization which carry the splitting nodes, and declare the resulting vertex to be the root of the resulting tree. Impose the central alignment condition, where the special root takes on the r\^ole previously occupied by the core.
\item Replace the fibre product factor in $\Ecal$ associated to the vertex $\sqC_0$
\begin{equation*} \ol\Mcal^{\leftrightarrow}_{\Gamma_{\tiny{\sqC_0}}}(\mathbb P|H_0+H_\infty) \end{equation*}
with the radially aligned rubber space:
\begin{equation*} \VZ^{\leftrightarrow}_{\Gamma_{\tiny{\sqC_0}}}(\mathbb P|H_0+H_\infty).\end{equation*}
(Here we are imposing fibre-direction factorisation in order to isolate the main component.)
 \end{enumerate} 
This procedure induces a logarithmic modification $\widetilde\Ecal \to \Ecal$ which admits a modular description as a fibre product of genus zero centrally aligned maps coming from the vertices $\sqC_1,\ldots,\sqC_r$, and genus one aligned rubber maps satisfying fibre-direction factorisation from the vertex $\sqC_0$.

By construction, we have a map $\widetilde\Dcal \to \widetilde\Ecal$ which is a compactification of a torus bundle over $\widetilde\Ecal$. The strata of $\widetilde\Dcal$ can be read off from its tropicalization, and in particular we have the information of how (polynomials in) the classes of boundary strata push forward to $\widetilde\Ecal$.

We have produced a factorisation
\begin{equation*}\widetilde\Dcal\to\widetilde \Ecal\to\Ecal,
\end{equation*}
where the first map is flat and the second map is a logarithmic modification. $\widetilde\Dcal$ is a compactification of a torus bundle over $\widetilde\Ecal$ whose strata can be read off from the tropicalization; in particular, we have the information of how (polynomials in) the classes of boundary strata push forward to $\widetilde\Ecal$. In fact, we can say more and describe the generic fibre of $\widetilde\Dcal \to \widetilde\Ecal$:
\begin{lemma}\label{lem:generic_proj_bundle}
Generically over $\Ecal$, the morphism $\widetilde \Dcal\to\widetilde\Ecal$ is the projectivisation of a tautological vector bundle.
\end{lemma}

\begin{proof}
Let us assume that the curve does not degenerate, so that the dual graph is as prescribed by $\Delta$. In particular there are components $\sqC_1,\ldots,\sqC_r$ generically lying on the circle of radius $\delta$. The moduli space of attaching data for the elliptic singularity is the complement of the coordinate hyperplanes in
$$\PP\left(\bigoplus_{i=1}^rT_{q_i}C_i\right)\DIFdelbegin \DIFdel{.}\DIFdelend \DIFaddbegin \DIFadd{,}\DIFaddend $$
\DIFaddbegin \DIFadd{see~\mbox{%DIFAUXCMD
\cite[Section~2.2]{SMY2}}%DIFAUXCMD
. A point in this space parameterizes a particular map from the rational multiple point singularity to the elliptic multiple point singularity. }\DIFaddend On the boundary, the circle is allowed to miss some of the $\sqC_i$ -- but not all of them! --  cutting the edge between them and the core (correspondingly, there is a destabilisation of the curve, and an elliptic singularity containing strictly semistable branches). Tropically, pushing some of the vertices off the circle creates new finite-length edges with coordinates $\ell_i\in\RR_{\geq_0}$ (see Figure \ref{fig:off_we_go}). Since not all of them can be strictly positive, this represents the fan of a projective space.

A slight modification of the argument above is required to account for the fact that all vertices that lie on the circle and are mapped to $0\in\mathbb R_{\geq0}$ by the tropical map are generically aligned on $\Ecal$: indeed, by Lemma \ref{lemma type C0 combinatorial types}, they all have the same contact order $m$, therefore their $T_{q_i}C_i^{\otimes m}$ can be identified via the target tangent line on the fibre product \eqref{IIIa fibre product}, and, after saturation, the $T_{q_i}C_i$ themselves are canonically isomorphic on $\Ecal$. Thus, only one summand should be taken to represent all of them in the projective bundle above.
\end{proof}

\begin{figure}
\includegraphics[scale=.3]{off_we_go}
\caption{Moving vertices off the circle creates new tropical parameters.}\label{fig:off_we_go}
\end{figure}

\subsubsection{$\Dcal$ from $\widetilde\Dcal$: first way}\label{subsection D from Dtilde} On $\widetilde\Dcal$ there is a tautological line bundle arising from the modular description of $\widetilde\VZ_{1,\alpha}(\PP^N|H,d)$, namely $\OO(\delta)$. \DIFaddbegin \DIFadd{Recall that the piecewise linear function $\delta$ may be viewed as a global section of the characteristic sheaf of the logarithmic structure on $\widetilde\VZ_{1,\alpha}(\PP^N|H,d)$. The toric geometry dictionary gives rise to an associated Cartier divisor. Alternatively, for any logarithmic stack $X$, the natural coboundary map induced by }$$\DIFadd{0\to \mathcal O_X^\star\to M_X\to \overline M_X\to 0}$$ \DIFadd{associates a $\mathcal O_X^\star$-torsor to a global section of the characteristic sheaf. 
}\DIFaddend 


\begin{lemma}\label{lemma fibres of Odelta}
The fibre of $\OO(\delta)$ over a moduli point is naturally isomorphic to
\begin{equation*} T_{p}C^\prime \otimes T C_0\end{equation*}
where $C^\prime$ is any component of $C$ which lies on the circle, $p$ is the adjacent node which points towards the core, and $T C_0$ is the universal tangent line bundle on the moduli space for $\sqC_0$.
\end{lemma}

\begin{proof}
Choose a component $C^\prime$ of the curve which lies on the circle. Then $\OO(\delta)$ is equal to the tensor product of tangent line bundles along the path of edges connecting $C^\prime$ to the core. However, this tensor product of line bundles is telescoping: any vertex which appears in the middle of the path will have an incoming and outgoing node, and since the vertex corresponds to a smooth rational curve these tangent spaces are naturally dual to each other~\cite[\S 2.2]{VZ}. Thus these factors cancel, and the result follows.
%Note that the final term on the right hand side is not given by $\TT_{q_i} C_0$ (where $q_i$ is the appropriate splitting node) but rather the tangent space to the core. 
\end{proof}
The content of Lemma \ref{lemma fibres of Odelta} is that the choice of point in the fibre of $\widetilde\Dcal \to \widetilde\Ecal$ provides a natural identification between the inward-pointing tangent spaces on the circle. This identification amounts to a specific linear dependence relation between the tangent vectors, which gives a point in the moduli space of attaching data for the corresponding elliptic singularity \cite[\S 2.2]{SMY2}. We may therefore express the factorisation condition in terms of the following natural morphism of vector bundles on $\widetilde\Dcal$:
\begin{equation*} \Sigma \operatorname{d}\!f \colon \OO(\delta)\otimes TC_0^\vee \to \ev_q^\st T H. \end{equation*}
Here $\Sigma \operatorname{d}\!f$ is defined by summing the images of the tangent vectors at the inward-pointing nodes on the circle, using the natural identification of each of these tangent spaces with $\OO(\delta)\otimes TC_0^\vee$ established above. By Lemma \ref{lemma type C0 combinatorial types} we have that it takes values in $TH$, rather than $T\PP^N$. This gives a section of the vector bundle
\begin{equation*} V = (\ev_q^\st TH) \otimes (TC_0) \otimes \OO(-\delta) \end{equation*}
which is transverse and whose vanishing locus coincides with $\Dcal$. Thus we obtain:
\begin{prop} \label{class of D} $[\Dcal] = \operatorname{e}(V) \cap [\widetilde\Dcal]$.\end{prop}
We claim that the class $\operatorname{e}(V)$ is tautological and computable. The only part which needs justification is $\OO(\delta)$. We claim that this can be obtained by pulling back a line bundle from $\Ecal$ and twisting by exceptional divisors.
\begin{lemma} For $i\in \{1,\ldots,r\}$ consider the line bundle
\begin{equation*} T_i = T_{q_i} C_i \otimes T_{q_i} C_0 \end{equation*}
on $\Ecal$, where $q_i$ is the splitting node. Then $\OO(\delta)$ is isomorphic to the pull-back of $T_i$ to $\widetilde\Dcal$ twisted by all exceptional divisors.\end{lemma}
We illustrate this lemma in the following example, which brings out the interplay between logarithmic moduli and \DIFdelbegin \DIFdel{blow-ups}\DIFdelend \DIFaddbegin \DIFadd{blowups}\DIFaddend .
\begin{example}
Consider the locus $\Ecal$ given by $\sigma$ below, and the exceptional divisor $\widetilde\Dcal_\rho \subseteq \widetilde\Dcal$ given by $\rho$:
\begin{figure}[!htbp]
\begin{minipage}{0.3\textwidth}
\centering
\begin{tikzpicture}
%\draw [red] plot [smooth cycle] coordinates {(0,-2) (-0.5,-1) (0,0) (1,0.5) (3,-1) (1,-2.5)};

\draw[fill=black] (0,0) circle[radius=2pt];
\draw (0,0) node[above]{\small$\sqC_1$};
\draw[fill=black] (0,0) -- (2,-1);
\draw (1,-0.95) node[above]{\small$e_1$};
\draw[color=blue] (1,-0.5) node[above]{\small$2$};

\draw[fill=black] (0,-2) circle[radius=2pt];
\draw (0,-2) node[above]{\small$\sqC_2$};

\draw[->] (0,-2) -- (0,-2.5);
\draw[color=blue] (0,-2.5) node[below]{\small$0$};

\draw[fill=black] (0,-2) -- (2,-1);
\draw (1,-2) node[above]{\small$e_2$};
\draw[color=blue] (1,-1.5) node[above]{\small$2$};

\draw[fill=black,->] (2,-1) -- (3.5,-1);
\draw[color=blue] (2.35,-1) node[above]{\small$4$};

\draw[fill=white] (2,-1) circle[radius=2pt];
\draw (2,-1) node[below]{\small$\sqC_0$};

\draw[color=blue,->] (2,-2) -- (2,-3);

\draw[color=blue,->] (0,-3.5) -- (3,-3.5);
\draw[fill=blue] (0,-3.5) circle[radius=2pt];
\draw[fill=blue] (2,-3.5) circle[radius=2pt];
\end{tikzpicture}
\caption{$\sigma$}
\end{minipage}\hfill
\begin{minipage}{0.7\textwidth}
\centering
\begin{tikzpicture}
\draw [red] plot [smooth cycle] coordinates {(-4,-2) (-2,-1) (-2,1) (0,1) (3,-1) (-1,-3.5)};

\draw[fill=black] (0,0) circle[radius=2pt];
\draw (0,0) node[above]{\small$\sqC_1^0$};
\draw[fill=black] (0,0) -- (2,-1);
\draw (1,-0.95) node[above]{\small$e_1$};
\draw[color=blue] (1,-0.5) node[above]{\small$2$};

\draw[fill=black] (0,-2) circle[radius=2pt];
\draw (0,-2) node[above]{\small$\sqC_2^0$};
\draw[fill=black] (0,-2) -- (2,-1);
\draw (1,-2) node[above]{\small$e_2$};
\draw[color=blue] (1,-1.5) node[above]{\small$2$};

\draw[fill=black,->] (2,-1) -- (3.5,-1);
\draw[color=blue] (2.35,-1) node[above]{\small$4$};

\draw[fill=white] (2,-1) circle[radius=2pt];
\draw (2,-1) node[below]{\small$\sqC_0$};

\draw (-2,1) -- (0,0);
\draw[fill=black] (-2,1) circle[radius=2pt];
\draw (-2,1) node[above]{\small$\sqC_1^1$};
\draw (-1,0.5) node[below]{\small$f_1$};
\draw[color=blue] (-1,0.5) node[above]{\small$1$};

\draw (-2,1) -- (-4,1);
\draw[fill=black] (-4,1) circle[radius=2pt];
\draw (-4,1) node[above]{\small$\sqC_1^3$};
\draw (-3,1) node[below]{\small$g_1$};
\draw[color=blue] (-3,1) node[above]{\small$1$};

\draw (-2,-1) -- (0,0);
\draw[fill=black] (-2,-1) circle[radius=2pt];
\draw (-2,-1) node[above]{\small$\sqC_1^2$};
\draw (-1,-0.5) node[below]{\small$f_2$};
\draw[color=blue] (-1,-0.5) node[above]{\small$1$};

\draw (-2,-1) -- (-4,-1);
\draw[fill=black] (-4,-1) circle[radius=2pt];
\draw (-4,-1) node[above]{\small$\sqC_1^4$};
\draw (-3,-1) node[below]{\small$g_2$};
\draw[color=blue] (-3,-1) node[above]{\small$1$};

\draw (0,-2) -- (-2,-2);
\draw[fill=black] (-2,-2) circle[radius=2pt];
\draw (-2,-2) node[above]{\small$\sqC_2^1$};
\draw (-1,-2) node[below]{\small$f_3$};
\draw[color=blue] (-1,-2) node[above]{\small$2$};
\draw[->] (-2,-2) -- (-2,-2.5);
\draw[color=blue] (-2,-2.5) node[below]{\small$0$};

\draw (-2,-2) -- (-4,-2);
\draw[fill=black] (-4,-2) circle[radius=2pt];
\draw (-4,-2) node[above]{\small$\sqC_2^2$};
\draw (-3,-2) node[below]{\small$g_3$};
\draw[color=blue] (-3,-2) node[above]{\small$2$};

\draw[color=blue,->] (0,-2.5) -- (0,-3.5);

\draw[color=blue,->] (-4,-4) -- (3,-4);
\draw[fill=blue] (0,-4) circle[radius=2pt];
\draw[fill=blue] (2,-4) circle[radius=2pt];
\draw[fill=blue] (-2,-4) circle[radius=2pt];
\draw[fill=blue] (-4,-4) circle[radius=2pt];
\end{tikzpicture}
\caption{$\rho$}
\end{minipage}
\end{figure}

On the cone $\rho$ we have the following tropical continuity equations
\begin{align*}
e:=e_1 = e_2, \qquad f:=f_1 = f_2 = 2f_3, \qquad g:=g_1 = g_2 = 2g_3
\end{align*}
together with the equation imposed by the choice of alignment:
\begin{align*} e_1 + f_1 = e_2 + f_3 + g_3 \qquad (\Longleftrightarrow f = g).
\end{align*}
From now on we use the same symbol to denote an edge length and the corresponding node on $\widetilde\Dcal_\rho$. On this locus we have line bundles pulled back from $\Ecal$
\begin{align*} T_1 & = T_{e_1} C_1^0 \otimes T_{e_1} C_0 \\
T_2 & = T_{e_2} C_2^0 \otimes T_{e_2} C_0\end{align*}
as well as the logarithmic line bundle
\begin{equation*} \OO(\delta) = T_{f_1} C_1^1 \otimes T_{e_1} C_0 = T_{f_2} C_1^2 \otimes T_{e_1} C_0 = T_{g_3} C_2^2 \otimes T_{e_2}C_0 
\end{equation*}
where the identifications follow from Lemma \ref{lemma fibres of Odelta}. We claim that: 
\begin{equation} \label{Odelta eqn} \OO(\delta) = T_1\otimes \OO(\widetilde\Dcal_\rho) = T_2 \otimes \OO(\widetilde\Dcal_\rho).\end{equation}
Notice that $\OO(\widetilde\Dcal_\rho) = \OO(f)=\OO(g)$. Thus we have
\begin{align*} T_1 \otimes \OO(\widetilde\Dcal_\rho) & = \OO(f_1) \otimes T_{e_1} C_1^0 \otimes T_{e_1}C_0 \\
& = T_{f_1}C_1^1 \otimes T_{f_1} C_1^0 \otimes T_{e_1} C_1^0 \otimes T_{e_1}C_0  \\
& = T_{f_1}C_1^1\otimes T_{e_1}C_0 \qquad (= \OO(\delta))
\end{align*}
where in the last line we have used the same telescoping trick used in the proof of Lemma \ref{lemma fibres of Odelta}, namely that $T_{f_1}C_1^0 \otimes T_{e_1} C_1^0 = \OO$. On the other hand, for $T_2$ we may write $f=f/2 + g/2=f_3+g_3$ in order to obtain:
\begin{equation*} T_2 \otimes \OO(\widetilde\Dcal_\rho) = \OO(g_3) \otimes \OO(f_3) \otimes T_{e_2} C_2^0 \otimes T_{e_2} C_0 = T_{g_3}C_2^2 \otimes T_{e_2}C_0 = \OO(\delta) \end{equation*}
where we have used the same telescoping trick. Thus we have proven \eqref{Odelta eqn}. This observation generalises, giving a precise relation between the intrinsically-defined line bundle $\OO(\delta)$ on $\widetilde\Dcal$ (which we use to impose the factorisation condition) and the the line bundles $T_i$ pulled back from $\Ecal$. This allows us to express the Chern classes of $\OO(\delta)$ (and hence $V$) in terms of pull-backs of tautological classes from $\Ecal$ and boundary strata on $\widetilde\Dcal$, which is sufficient in order to compute integrals.
\end{example}


\subsubsection{$\Dcal$ from $\widetilde\Dcal$: second way} To establish a more direct connection with the geometry of the fibre product \eqref{IIIa fibre product}, recall that $\widetilde\Ecal$ is built as an explicit modification of a finite cover of \eqref{IIIa fibre product}. For $i \in\{1,\ldots,r\}$ (with the convention established at the end of Lemma \ref{lem:generic_proj_bundle}), it makes sense on $\widetilde\Ecal$ to consider the line bundle $\OO(\delta_i)$ associated to a shortest path from the core to the circle in the $\sqC_i$-direction. Construct
\begin{equation*}\mathcal P=\PP_{\widetilde\Ecal}\left(\bigoplus_{i=1}^r\OO(\delta_i)\right).\end{equation*}
Since $\sqC_1,\ldots,\sqC_r$ are always ordered on $\widetilde \Dcal$ (they may lie on the circle, be the first component off the circle, or degenerate and lie in the strict interior), there is a morphism $\widetilde \Dcal\to\mathcal P$ lifting $\widetilde \Dcal\to\widetilde\Ecal$. Consider the map of vector bundles on $\mathcal P$:
\begin{equation*}  \OO_{\mathcal P}(-1)\to p^*\left(\bigoplus_{i=1}^r\OO(\delta_i)\right)\xrightarrow{\sum\operatorname{d}\!f}\ev_q^*TH.\end{equation*}
The composite, regarded as a section $s$ of $W=\OO_{\mathcal P}(1)\otimes \operatorname{ev}_q^*(TH)$, vanishes precisely where $f$ factors through the elliptic singularity determined by the point in the fibre of $p$. Generically on $\widetilde\Ecal$, this is exactly what we are after (compare with Lemma \ref{lem:generic_proj_bundle}). On the boundary, though, it may happen that a simultaneous degeneration in the base and the fibre makes this factorisation trivial, in the sense that the map $\bar f$ is constant on all the branches of the elliptic singularity.

\begin{lemma}
 For every $\Lambda_B\subseteq \{\sqC_1,\ldots,\sqC_r\}$ and $\Lambda_F=\{\sqC_1,\ldots,\sqC_r\}\setminus \Lambda_B$, $s$ vanishes along the loci where the factors corresponding to $\Lambda_B$ in $\widetilde \Ecal$ degenerate so that $f_i\colon C_i\to\PP^N$ is constant in a neighbourhood of $q_i$, and the fibre coordinates $(\lambda_j)_{j\in\Lambda_F}$ along $p\colon\mathcal P\to\widetilde \Ecal$ are set to be $0$.
\end{lemma}
Call these loci $\Xi_\Lambda$ for $\Lambda=(\Lambda_B,\Lambda_F)$ (compare with \cite[\S 3.2]{VZ} for an analogous phenomenon in the non-relative case); clearly, they may be in excess with respect to the expected codimension of $V(s)$, that is $N-1$. These loci are logarithmic substrata; therefore, there exists a logarithmic \DIFdelbegin \DIFdel{blow-up }\DIFdelend \DIFaddbegin \DIFadd{blowup }\DIFaddend that principalises them. We claim which $\widetilde\Dcal$ is (possibly a refinement of) such a \DIFdelbegin \DIFdel{blow-up}\DIFdelend \DIFaddbegin \DIFadd{blowup}\DIFaddend . 
\begin{lemma}
 The pullback of $\Xi_\Lambda$ is principal in $\widetilde\Dcal$.
\end{lemma}
\begin{proof}We analyse the ideal of $\Xi_\Lambda$: it is generated by
  \begin{enumerate} 
  \item equations on $\widetilde\Ecal$ cutting the locus where $C_i$ degenerates so that $f_i$ is constant on a neighbourhood of $q_i$ for $i\in \Lambda_B$: these correspond to the tropical functions $\delta_i-\lambda(q_i)$ where $\lambda$ is the distance function to the core;
  \item equations on the fibre of $p$ for the linear subspace corresponding to $i\in \Lambda_F$: tropically, these correspond to the $\ell_i$ discussed in Lemma \ref{lem:generic_proj_bundle}.
  \end{enumerate} 
By construction, on $\widetilde \Dcal$ it is always possible to tell which of these tropical lengths is the shortest (the circle we have drawn on $\Xi_\Lambda$ is degenerate -- it passes through no vertex of positive horizontal degree -- therefore we need to decide for a strictly larger circle in order to lift to $\widetilde D$), which corresponds to principalising the ideal (see Figure \ref{fig:principalisation}).
\end{proof}

\begin{figure}
\includegraphics[scale=.5]{principalisation}
\caption{On the left, a generic point of $\mathcal P$. On the right, a point of $\Xi$. The dotted circle is the one we draw on $\mathcal P$. The continuous circle represents one of the possible choices of $\delta$ enlarging the dotted one (a stratum of $\widetilde\Dcal$).}\label{fig:principalisation}
\end{figure}

Finally, on $\widetilde\Dcal$ (or, in fact, on an intermediate \DIFdelbegin \DIFdel{blow-up }\DIFdelend \DIFaddbegin \DIFadd{blowup }\DIFaddend $\widetilde{\mathcal P}\to\mathcal P$) there are exceptional divisors $\widetilde \Xi_\Lambda$ corresponding to $\Xi_\Lambda$ in $\mathcal P$. Since the $\Xi_\Lambda$ exhaust all the excess-dimensional components of the vanishing locus of $s\in H^0(\mathcal P,W)$, the latter induces a section $\tilde s\in H^0(\widetilde\Dcal,W(-\Sigma_\Lambda \widetilde\Xi_\Lambda))$ by pullback and twisting, whose vanishing locus is dimensionally transverse to the boundary, and whose open part coincides with the generic point of $\Dcal$, therefore $V(\tilde s)=\Dcal$.

Expressing the pushforward of the Chern classes of $\OO_W(1)$ and $\OO(\widetilde\Xi_\Lambda)$ in terms of tautological classes on the fibre product underlying $\Ecal$, we get:
\begin{cor}
 After pushforward to $\Ecal$, the contribution of $\Dcal$ to the invariants can be computed in terms of tautological integrals on moduli spaces of maps with lower numerics.
\end{cor}

\subsection{Recursion for general $(X,Y)$}\label{section recursion for general pair} Now let $(X,Y)$ be a general smooth very ample pair. In \S \ref{subsection virtual} we studied the moduli space $\VZ_{1,\alpha}(X|Y,\beta)$ of centrally aligned maps to $(X,Y)$ and equipped it with a virtual fundamental class by diagonal pull-back from $\VZ_{1,\alpha}(\PP^N|H,d)$.

This construction of the virtual fundamental class means that once we have established a recursion formula for $(\PP^N,H)$, it immediately pulls back to give a recursion formula for $(X,Y)$. To be more precise, Theorem \ref{theorem recursion} holds \emph{mutatis mutandis}, with the same values of $\lambda_\Dcal$. The computation of the splitting orders is exactly the same, and the recursive description of the boundary strata pulls back to give an entirely analogous description on $\VZ_{1,\alpha}(X|Y,\beta)$.


\section{Quantum Lefschetz algorithm}\label{section recursion algorithm}
Consider a smooth pair $(X,Y)$ with $Y$ very ample, and let $\mathbb{P}$ be the projective bundle $\mathbb{P}=\PP_Y(\operatorname{N}_{Y|X} \oplus\OO_Y)$. We assume that the genus zero and reduced genus one Gromov--Witten theories of $X$ are known. From this starting data, we will apply our recursion formula to compute:
 \begin{enumerate} 
\item the genus one \textbf{reduced restricted absolute Gromov--Witten theory} of $Y$;
\item the genus one \textbf{reduced relative Gromov--Witten theory} of the pair $(X,Y)$;
\item the genus one \textbf{reduced rubber theory} of $\mathbb{P}$.
 \end{enumerate} 

\subsection{Reduced absolute, relative and rubber invariants} To be precise: by a reduced invariant of $Y$ we mean an integral over $\VZ_{1,n}(Y,\beta)$ of products of pullbacks of evaluation and psi classes along morphisms which forget a subset $S$ of the marked points (taking $S=\emptyset$ gives the ordinary evaluation and psi classes). Here the evaluation maps are viewed as mapping into $X$ (hence the adjective ``restricted''). Reduced relative invariants of $(X,Y)$ are defined in the same way, except now the forgetful morphism maps into a space of absolute maps:
\begin{equation*} \fgt_S \colon \VZ_{1,\alpha}(X|Y,\beta) \to \VZ_{1,m-\#S}(X,\beta).\end{equation*}
In particular, all the psi classes which we consider are \textbf{collapsed psi classes}, meaning that they are relative cotangent line classes for the corresponding collapsed stable map. Note that, unlike in the absolute case, in the relative case it may well be the case that the entire insertion is pulled back along a single forgetful map $\fgt_S$. The reduced rubber invariants of $\mathbb{P}$ are defined similarly (again using collapsed psi classes).

The systems of invariants defined above are equivalent to the classical systems of invariants (which do not use forgetful morphisms) by well-known topological recursion relations.

\subsection{Fictitious and true markings} The recursion procedure is rather delicate. Roughly speaking, we will induct on the degree (meaning $Y\cdot\beta$), number of marked points and total tangency. To get the correct notion of number of markings and total tangency in  the relative setting, we introduce the concept of \textbf{fictitious markings}. Consider a moduli space $\VZ_{1,\alpha}(X|Y,\beta)$ of reduced relative stable maps and a corresponding integrand $\gamma$. We let $F \subseteq \{1,\ldots,m\}$ be the maximal subset of marked points such that:
 \begin{enumerate} 
\item $\alpha_i = 1$ for all $i \in F$;
\item the entire integrand $\gamma$ is pulled back along $\fgt_F$.
 \end{enumerate} 
This subset is uniquely determined, and its elements are referred to as \textbf{fictitious markings}. Markings which are not fictitious are referred to as \textbf{true}. When inducting on relative invariants we will always be interested in the number of true markings (as opposed to the total number of markings) and the true tangency
\begin{equation*} \sum_{i \not\in F} \alpha_i \leq d=Y\cdot \beta \end{equation*}
as opposed to the total tangency, which is always $d$. This formalises the idea that relative invariants with non-maximal tangency $t<d$ can be obtained by adding $d-t$ fictitious markings of tangency $1$; see \cite[Lemma 1.15(i)]{Ga}.

\subsection{Structure of the recursion} Given the genus-zero Gromov--Witten theory of $X$, the arguments of \cite{Ga} give an effective algorithm to reconstruct the genus-zero theories of $Y$ and $(X,Y)$; \DIFdelbegin \DIFdel{moreover, }\DIFdelend the genus-zero rubber theory of $\mathbb{P}$ is \DIFdelbegin \DIFdel{identical }\DIFdelend \DIFaddbegin \DIFadd{equal }\DIFaddend to the genus-zero theory of $Y$ \cite{GathmannThesis}. Thus we may assume that all genus-zero data is known. We assume in addition that we know the genus one reduced theory of $X$. The structure of the recursion is then as follows:

\begin{algorithm}
\DontPrintSemicolon
\For{$d \geq 0$}{
\For{$n \geq 0$}{
\For{$t \geq 0$\medskip}{
\textbf{\, Step 1: } Compute forgetful relative invariants of $(X,Y)$ (degree~$d$, $n+1$ true markings, true tangency $t$); see below.
}
\medskip \textbf{Step 2: } Compute absolute invariants of $Y$ (degree $d$, $n$ markings).\;
\For{$t \geq 0$\medskip}{
\textbf{\, Step 3: } Compute relative invariants of $(X,Y)$ (degree $d$, $n$ true markings, true tangency $t$).\;
}
}
\For{$n \geq 0$\medskip}{
\For{$m \geq 0$\medskip}{
\textbf{\, Step 4: } Compute rubber invariants of $\mathbb{P}$ (degree $d$, $n$ relative markings, $m$ non-relative markings).
}
}
}
\end{algorithm}
\noindent Although the loops involving $d, n$ and $m$ have infinite length, in order to compute any single invariant it is only necessarily to iterate the preceding loops for a finite amount of time. A \textbf{forgetful relative invariant} of $(X,Y)$ is by definition a reduced relative invariant with a marked point $x_0$ such that all of the insertions are pulled back along $\fgt_{x_0}$. In our recursion, we first deal with this special class of relative invariants (with $n+1$ true markings), before computing the absolute invariants (with $n$ markings) and then returning to compute all of the relative invariants (with $n$ true markings). This need to treat separately a particular subclass of the relative invariants is an inescapable feature of the genus one recursion.

The base terms of the recursion all have $d=0$ and as such are easy to compute: the relative invariants of $(X,Y)$ are nothing but absolute invariants of $X$ and the absolute invariants of $Y$ are given by obstruction bundle integrals over Deligne--Mumford spaces. The rubber invariants of $\mathbb{P}$ in degree zero are given by integrals over the main component of the double ramification cycle; this can likewise be computed as an integral over Deligne--Mumford space, by correcting the formula for the ordinary double ramification cycle \cite{Hain,JPPZ} by the obvious contribution from the boundary irreducible component (the observation which makes this easy to do in genus one is that the rubber moduli space is pure-dimensional, so that the virtual class is simply the sum of the fundamental classes of the irreducible components). We will now explain how to perform each of the four inductive steps outlined above.

\begin{notation}Given tuples $\mathbf{a}=(a_1,\ldots,a_n)$ and $\mathbf{b}=(b_1,\ldots,b_n)$, we say that $\mathbf{a}<\mathbf{b}$ if there exists an $i \in \{1,\ldots,n\}$ such that $a_j = b_j$ for $j < i$ and $a_i < b_i$.\end{notation}

\subsection*{Step 1} Suppose we are given a forgetful relative invariant to compute. That is, we have a relative space $\VZ_{1,\alpha}(X|Y,\beta)$ of degree $d$, with $n+1$ true markings and true tangency $t$, and a marking $x_0$ such that the insertion $\gamma$ is pulled back along $\fgt_{x_0}$. We assume inductively that every absolute, relative and rubber invariant with $(d^\prime,n^\prime) < (d,n)$ is known, and also that every forgetful relative invariant with $(d^\prime,n^\prime,t^\prime) < (d,n+1,t)$ is known. Choose a true marking $x_1$ with $\alpha_1 \geq 1$ and consider the space:
\begin{equation*} \VZ_{1,(\alpha-e_1) \cup (1)}(X|Y,\beta). \end{equation*}
Denote the newly-introduced marking by $y$ and consider the integrand $\tilde\gamma$ obtained from $\gamma$ by introducing $\fgt_y^\st$ everywhere. Applying our recursion formula to $x_1$, we obtain:
\begin{equation}\label{step 1 recursion}\left( (\alpha_1-1)\psi_1 + \ev_1^\st Y\right) \tilde\gamma \cap [\VZ_{1,(\alpha-e_1) \cup (1)}(X|Y,\beta)] = \tilde\gamma \cap [\Dcal(1)].\end{equation}
Let us first examine the left-hand side. The class $\psi_1$ differs from $\fgt_y^\st \psi_1$ by the locus where $x_1$ and $y$ are contained on a contracted rational bubble. This locus consists of reduced relative stable maps of the form \medskip

\begin{center}
\begin{tikzpicture}[scale=1]
%edge
\draw (0,0) to (2,0);
\draw [color=blue] (1,0) node[above]{\tiny$\alpha_1$};

%C_1
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};
\draw (0,0) node[above]{\small$\sqC_1$};

%C_0
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};
\draw (2,0) node[above]{\small$\sqC_0$};

%x_1
\draw [->] (2,0.1) -- (4,0.1);
\draw (3.9,0.1) node[above]{\small$x_1$};
\draw [color=blue](3,0.1) node[above]{\tiny$\alpha_1-1$};

%y
\draw [->] (2,-0.1) -- (4,-0.1);
\draw (3.9,-0.1) node[below]{\small$y$};
\draw [color=blue] (3,-0.1) node[below]{\tiny$1$};

%down arrow
\draw [color=blue,->] (1,-0.3) -- (1,-0.7);

%target
\draw [color=blue,->] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [color=blue] (2,-1) node[right]{\small$\Sigma(X|Y)$};
\end{tikzpicture}
\end{center}
% Algebro-geometric picture; replaced by tropical picture.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{comment}
\begin{center}
\begin{tikzpicture}[scale=1.5]
%Draw target
\draw (0,0) -- (3,0) -- (3,2) -- (0,2) -- (0,0);
\draw (3,0) -- (6,0) -- (6,2) -- (3,2) -- (3,0);

%Draw genus one curve on left-hand side
\draw [blue] (3,0.5) to [out=90,in=270] (2.7,1) to [out=90,in=270] (3,1.5) to [out=90,in=0] (1,1.7) to [out=180,in=90] (0.5,1) to [out=270,in=180] (1,0.3) to [out=0,in=270] (3,0.5);
\draw [blue] (1.1,0.9) to [out=40, in=180] (1.4,1.1) to [out=0,in=140] (1.7,0.9);
\draw [blue] (1.2,1) to [out=300, in=180] (1.4,0.9) to [out=0,in=240] (1.6,1);

%Draw nodal blobs
\draw [fill=blue,color=blue] (3,0.5) circle[radius=1pt];
\draw [color=blue] (3,0.5) node[left]{\small$\alpha_2$};
\draw [fill=blue,color=blue] (3,1.5) circle[radius=1pt];
\draw [color=blue] (3,1.5) node[left]{\small$\alpha_1$};
%Draw rational bubble with x_1 and y
\draw [blue] (3,1.5) to [out=70,in=190] (5.5,1.9) to [out=0,in=90] (6,1.8) to [out=270,in=90] (5.75,1.5) to [out=270,in=90] (6,1.2) to [out=270,in=10] (5.5,1.1) to [out=180,in=290] (3,1.5);

%Draw right-hand markings
\draw [fill=blue,color=blue] (6,1.8) circle[radius=1pt];
\draw [color=blue] (6,1.8) node[left]{\small{$\alpha_1-1$}};
\draw (6,1.8) node[right]{$x_1$};
\draw [fill=blue,color=blue] (6,1.2) circle[radius=1pt];
\draw [color=blue] (6,1.2) node[left]{\small{$1$}};
\draw (6,1.2) node[right]{$y$};

%Draw ldots
\draw [color=blue] (4,0.5) node[right]{$\ldots$};
\end{tikzpicture}
\end{center}
\end{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
with all other marked points contained on $\sqC_1$. This is isomorphic to $\VZ_{1,\alpha}(X|Y,\beta)$ and when we restrict $\tilde\gamma$ to this locus we obtain precisely the class $\gamma$ which we started with. Thus the left-hand side of \eqref{step 1 recursion} may be written as
\begin{equation*} (\alpha_1-1) I + \fgt_y^\st \left( (\alpha_1-1)\psi_1 + \ev_1^\st Y\right)  \tilde\gamma \cap [\VZ_{1,(\alpha-e_1)\cup(1)}(X|Y,\beta)]\end{equation*}
where $I$ is the invariant we are trying to compute. The second term is a forgetful relative invariant with the same degree and number of true markings (since $y$ is fictitious), and strictly smaller true tangency; hence it is recursively known. We now examine the right-hand side of \eqref{step 1 recursion}. Recall that all of the genus zero data has already been computed, so we only need to focus on the genus one pieces. First consider the type I loci. The genus one piece has strictly smaller degree (and hence is recursively known) except in the following situation (with some stable distribution of the remaining markings):
\begin{center}
\begin{tikzpicture}[scale=1]
\draw (0,0) to (2,0);
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};
\draw (0,0) node[above]{\small$\sqC_1$};
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};
\draw (2,0) node[above]{\small$\sqC_0$};
\draw [->] (2,0) -- (3,0);
\draw (2.9,0) node[right]{$x_1$};

\draw [color=blue,->] (1,-0.3) -- (1,-0.7);

\draw [color=blue,->] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [color=blue] (2,-1) node[right]{\small$\Sigma(X|Y)$};
\end{tikzpicture}
\end{center}
In this situation, $C_1$ contains at most $n+1$ true markings. If it has $n-1$ or fewer, than it is known recursively. If it has exactly $n$ this means that $C_0$ contains exactly one true marking (besides $x_1$, which may be true or fictitious). We claim that in this situation we must have $y \in C_1$, since otherwise we would have a moduli space for $C_0$ given by $\ol\Mcal_{0,k}$ with $k \geq 4$, and  applying the projection formula with $\fgt_y$ we would conclude that the contribution is zero. Thus we have $y \in C_1$, and so the genus one contribution is a forgetful relative invariant with $n$ true markings, and hence is recursively known.

Finally, if $C_1$ contains exactly $n+1$ true markings, then the only additional markings on $C_0$ are fictitious, and by the same argument as in the previous paragraph there can only be one. Thus for each fictitious marked point we obtain a locus isomorphic to $\VZ_{1,\alpha}(X|Y,\beta)$ and $\tilde\gamma$ restricts to $\gamma$ here (from the point of view of computing invariants, the fictitious marked points are indistinguishable, meaning that the contributions are all the same). Thus for each fictitious marked point (of which there is at least one, namely $y$) we get a contribution of $\alpha_1 I$ to the right-hand side of \eqref{step 1 recursion}.

The contributions of the type II loci only involve genus zero data and hence are known. The contributions of the type $\dag$ loci are determined by genus zero data and tautological integrals on Deligne--Mumford space, hence are also known. It remains to consider type III loci. If the degree of the genus one piece is less than $d$ then we have a rubber invariant of strictly smaller degree. The only other possibility is that the entire curve is mapped into the divisor. In this case we may apply the projection formula with $\fgt_y$ to identify this with an integral over $\VZ_{1,m}(Y,\beta)$ for some (possibly large) number $m$ of marked points. But by assumption there is another marked point $x_0$ with all of the insertions pulled back along $\fgt_{x_0}$, so a further application of the projection formula shows that this contribution vanishes. To conclude, we may rearrange \eqref{step 1 recursion} to obtain an expression of the form
\begin{equation*} \lambda I = \text{recursively known terms} \end{equation*}
where $\lambda$ is an explicit scalar which is always nonzero; we have thus determined $I$, which completes Step 1.

\subsection*{Step 2} Consider now the absolute space $\VZ_{1,n}(Y,\beta)$ with an insertion $\gamma$, and suppose inductively that we have computed all forgetful relative invariants with $(d^\prime,n^\prime) \leq (d,n+1)$, all relative invariants and absolute invariants with $(d^\prime,n^\prime) < (d,n)$, and all special rubber invariants with $d^\prime < d$. Consider the following moduli space with $n+1$ markings:
\begin{equation*} \VZ_{1,(d,0,\ldots,0)}(X|Y,\beta). \end{equation*}
Let $x_0$ denote the relative marking and consider the integrand $\tilde\gamma$ obtained from $\gamma$ by introducing $\fgt^\st_{x_0}$ everywhere. Now recurse at $x_1$ to obtain:
\begin{equation}\label{step 2 recursion} \ev_1^\st Y \cdot \tilde\gamma \cap [\VZ_{1,(d,0,\ldots,0)}(X|Y,\beta)] = \tilde\gamma\cap[\Dcal(1)].\end{equation}
The left-hand side is a forgetful relative invariant of degree $d$ and $\leq n+1$ true markings, and so has already been computed. For the right-hand side, let us begin with loci of type I. The genus one contributions from each loci have $(d^\prime,n^\prime) < (d,n)$ except in the following case
\begin{center}
\begin{tikzpicture}[scale=1]
%edge
\draw (0,0) to (2,0);
\draw [color=blue] (1,0) node[above]{\tiny$d$};

%C_1
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};
\draw (0,0) node[above]{\small$\sqC_1$};

%C_0
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};
\draw (2,0) node[above]{\small$\sqC_0$};

%x_1
\draw [->] (2,0.1) -- (4,0.1);
\draw (3.9,0.1) node[above]{\small$x_1$};
\draw [color=blue](3,0.1) node[above]{\tiny$0$};

%y
\draw [->] (2,-0.1) -- (4,-0.1);
\draw (3.9,-0.1) node[below]{\small$x_0$};
\draw [color=blue] (3,-0.1) node[below]{\tiny$d$};

%down arrow
\draw [color=blue,->] (1,-0.3) -- (1,-0.7);

%target
\draw [color=blue,->] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [color=blue] (2,-1) node[right]{\small$\Sigma(X|Y)$};
\end{tikzpicture}
\end{center}
which gives a contribution of
\begin{equation*} d\cdot \gamma \cap [\VZ_{1,(d,\underbrace{0,\ldots,0}_{n-1})}(X|Y,\beta)]\end{equation*}
to the right-hand side of \eqref{step 2 recursion}. Here $\gamma$ is the insertion we started with; the difference is that we are now considering relative maps to $(X,Y)$ with maximal tangency at $x_1$, rather than absolute maps to $Y$. The type II and $\dag$ loci are recursively determined as in Step~1, and similarly the type III loci are recursively determined except for the locus where the entire curve is mapped into the divisor. On this locus we may apply $\fgt_{x_0}$ and identify the contribution with
\begin{equation*} d^2 \cdot \gamma \cap [\VZ_{1,n}(Y,\beta)] = d^2 \cdot I \end{equation*}
where $I$ is the invariant we are trying to compute. Putting this all together, we obtain
\begin{equation}\label{step 2 recursion 2} I = (-\gamma/d) \cap [\VZ_{1,(d,\underbrace{0,\ldots,0}_{n-1})}(X|Y,\beta)] + \text{recursively known terms} \end{equation}
where on the right-hand side there are $n-1$ non-relative markings $x_2,\ldots,x_n$, and a relative marking $x_1$. We now apply the recursion again to the right-hand side, by considering the space
\begin{equation*} \VZ_{1,(d-1,1,0,\ldots,0)}(X|Y,\beta) \end{equation*}
where $x_1$ now has tangency $d-1$ and we have introduced a new marking $y$ with tangency $1$. We consider a new insertion, denoted $\tilde\gamma$ as usual, by introducing $\fgt_y^\st$ everywhere. Recursing at $x_1$ we obtain:
\begin{equation}\label{step 2 recursion 3} \left( (d-1)\psi_1 + \ev_1^\st Y \right)\cdot(-\tilde\gamma/d) \cap [\VZ_{1,(d-1,1,0,\ldots,0)}(X|Y,\beta)] = (-\tilde\gamma/d) \cap [\Dcal(1)].\end{equation}
The difference between $\psi_1$ and $\fgt_y^\st \psi_1$ is given by the locus where $x_1$ and $y$ belong to a collapsed rational bubble:
\begin{center}
\begin{tikzpicture}[scale=1]
%edge
\draw (0,0) to (2,0);
\draw [color=blue] (1,0) node[above]{\tiny$d$};

%C_1
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};
\draw (0,0) node[above]{\small$\sqC_1$};

%C_0
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};
\draw (2,0) node[above]{\small$\sqC_0$};

%x_1
\draw [->] (2,0.1) -- (4,0.1);
\draw (3.9,0.1) node[above]{\small$y$};
\draw [color=blue](3,0.1) node[above]{\tiny$1$};

%y
\draw [->] (2,-0.1) -- (4,-0.1);
\draw (3.9,-0.1) node[below]{\small$x_1$};
\draw [color=blue] (3,-0.1) node[below]{\tiny$d-1$};

%down arrow
\draw [color=blue,->] (1,-0.3) -- (1,-0.7);

%target
\draw [color=blue,->] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [color=blue] (2,-1) node[right]{\small$\Sigma(X|Y)$};
\end{tikzpicture}
\end{center}
The contribution of this locus to the left-hand side of \eqref{step 2 recursion 3} is:
\begin{equation*} (d-1)\cdot(-\gamma/d) \cap [\VZ_{1,(d,\underbrace{0,\ldots,0}_{n-1})}(X|Y,\beta)].\end{equation*}
What remains on the left-hand side is a forgetful relative invariant of degree $d$ and $\leq n+1$ true markings ($y$ being the ``forgetful'' marking), hence is recursively known. On the right-hand side, the type I loci are recursively known except possibly in the following special cases (with some stable distribution of the remaining non-relative markings):
\begin{center}
\begin{minipage}{0.4\textwidth}
\begin{tikzpicture}[scale=1]
%edge
\draw (0,-0.1) to (2,-0.1);
\draw [color=blue] (1,-0.1) node[below]{\tiny$d-1$};

%C_1
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};
\draw (0,0) node[above]{\small$\sqC_1$};

%C_0
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};
\draw (2,0) node[above]{\small$\sqC_0$};

%x_1
\draw [->] (0,0.1) -- (1.5,0.1);
\draw (1.5,0.1) node[above]{\small$y$};
\draw [color=blue](0.75,0.1) node[above]{\tiny$1$};

%y
\draw [->] (2,0) -- (4,0);
\draw (3.9,0) node[below]{\small$x_1$};
\draw [color=blue] (3,0) node[below]{\tiny$d-1$};

%down arrow
\draw [color=blue,->] (1,-0.5) -- (1,-0.9);

%target
\draw [color=blue,->] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [color=blue] (2,-1) node[right]{\small$\Sigma(X|Y)$};

\draw (2,-1.3) node[below]{\small{Case 1}};
\end{tikzpicture}
\end{minipage}
\begin{minipage}{0.4\textwidth}
\begin{tikzpicture}[scale=1]
%edge
\draw (0,0) to (2,0);
\draw [color=blue] (1,0) node[above]{\tiny$d$};

%C_1
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};
\draw (0,0) node[above]{\small$\sqC_1$};

%C_0
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};
\draw (2,0) node[above]{\small$\sqC_0$};

%x_1
\draw [->] (2,0.1) -- (4,0.1);
\draw (3.9,0.1) node[above]{\small$y$};
\draw [color=blue](3,0.1) node[above]{\tiny$1$};

%y
\draw [->] (2,-0.1) -- (4,-0.1);
\draw (3.9,-0.1) node[below]{\small$x_1$};
\draw [color=blue] (3,-0.1) node[below]{\tiny$d-1$};

%down arrow
\draw [color=blue,->] (1,-0.3) -- (1,-0.7);

%target
\draw [color=blue,->] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [color=blue] (2,-1) node[right]{\small$\Sigma(X|Y)$};

\draw (2,-1.3) node[below]{\small{Case 2}};
\end{tikzpicture}
\end{minipage}
\end{center}
In Case 1 the contribution from $C_1$ is a forgetful relative invariant with $\leq n$ true markings, hence is recursively known. In Case 2, we first note that there cannot be any more markings on $C_0$ (since otherwise we could apply $\fgt_y$ and conclude that the contribution vanishes). Thus we obtain a single locus, which contributes precisely
\begin{equation*} d\cdot(-\gamma/d) \cap [\VZ_{1,(d,\underbrace{0,\ldots,0}_{n-1})}(X|Y,\beta)] = -\gamma\cap[\VZ_{1,(d,\underbrace{0,\ldots,0}_{n-1})}(X|Y,\beta)]\end{equation*}
which gives us the first term on the right-hand side of \eqref{step 2 recursion 2}. As usual the type II and $\dag$ contributions are known recursively, and the only type III contribution not known recursively occurs when the entire curve is mapped into the divisor, in which case we apply $\fgt_y$ to calculate the contribution as:
\begin{equation*} (-\gamma/d) \cap [\VZ_{1,n}(Y,\beta)] = -I/d.\end{equation*}
Substituting into \eqref{step 2 recursion 2} we end up with
\begin{equation*} I(1-d^{-1}) = \text{recursively known terms} \end{equation*}
which completes the recursion step as long as $d \neq 1$. But since $\VZ_{1,n}(H,1)=\emptyset$ \DIFaddbegin \DIFadd{as noted in Remark~\ref{rem: constant-maps}, }\DIFaddend it follows that $\VZ_{1,n}(Y,\beta)=\emptyset$ if $d=Y\cdot\beta=1$, so we may always assume $d \geq 2$ in the recursion.

\subsection*{Step 3} Now suppose we are given a relative space $\VZ_{1,\alpha}(X|Y,\beta)$ with an insertion $\gamma$, and suppose inductively that we have computed all forgetful relative invariants with $(d^\prime,n^\prime) \leq (d,n+1)$, all absolute invariants with $(d^\prime,n^\prime) \leq (d,n)$, all relative invariants with $(d^\prime,n^\prime,t^\prime)<(d,n,t)$ and all rubber invariants with $d^\prime < d$. Choose a true marking $x_1$ with $\alpha_1 \geq 1$ and consider the moduli space
\begin{equation*} \VZ_{1,(\alpha-e_1)\cup(1)}(X|Y,\beta) \end{equation*}
where $y$ is the newly-introduced marking. As usual consider the insertion $\tilde\gamma$ obtained from $\gamma$ by introducing $\fgt_y$ everywhere. Recursing at $x_1$ we obtain:
\begin{equation*} \left( (\alpha_1-1)\psi_1 + \ev_1^\st H\right) \tilde\gamma \cap [\VZ_{1,(\alpha-e_1)\cup(1)}(X|Y,\beta)] = \tilde\gamma \cap [\Dcal(1)].\end{equation*}
The left-hand side is a relative invariant with the same degree and number of true markings, but smaller true tangency: hence it is recursively known. On the right-hand side, the type I contributions are recursively known except for those of the following form

\begin{center}
\begin{tikzpicture}[scale=1]
\draw (0,0) to (2,0);
\draw [color=blue] (1,-0.05) node[above]{\tiny$\alpha_1$};
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};
\draw (0,0) node[above]{\small$\sqC_1$};
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};
\draw (2,0) node[above]{\small$\sqC_0$};
\draw [->] (2,0) -- (4,0);
\draw (3.9,0) node[right]{$x_1$};
\draw [color=blue] (3,-0.05) node[above]{\tiny$\alpha_1-1$};

\draw [color=blue,->] (1,-0.3) -- (1,-0.7);

\draw [color=blue,->] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [color=blue] (2,-1) node[right]{\small$\Sigma(X|Y)$};
\end{tikzpicture}
\end{center}
where $C_0$ contains a single fictitious marking (if it had multiple fictitious markings then the contribution would vanish by projection formula) and all the other markings are on $C_1$. Thus for each fictitious marking we get a contribution of $\alpha_1 I$ where $I$ is the invariant we are trying to compute. Note that $\alpha_1 \neq 0$, and that this term appears at least once since $y$ is a fictitious marking; so we get a nonzero multiple of $I$.

As usual the type II and $\dag$ contributions are recursively known. The type $III$ contributions are determined by lower-degree rubber invariants, except for when the whole curve is mapped into $Y$; however in this case we may apply $\fgt_y$ to identify the contribution with an absolute invariant of $Y$ with degree $d$ and $n$ markings, which is also recursively known. Thus we have determined the invariant $I$.

\subsection*{Step 4} Finally, consider a rubber space $\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P|Y_0+Y_\infty,\beta)$ with insertion $\gamma$. Suppose inductively that we have computed all absolute and relative invariants with $d^\prime \leq d$ and all rubber invariants with $(d^\prime,n^\prime,m^\prime) < (d,n,m)$.

We first note the following important reduction: if there exists a relative marking $x_k$ such that all insertions are pulled back along $\fgt_{k}$, then we may apply the projection formula, together with the fact that
\begin{equation*} (\fgt_{k})_\st [\VZ^{\leftrightarrow}_{1,\alpha}(\mathbb P|Y_0+Y_\infty,\beta)] = \alpha_k^2 \cdot [\VZ_{1,n+m-1}(Y,\beta)] \end{equation*}
to identify the rubber invariant with a multiple of a reduced invariant of $Y$, which has the same degree and hence is known recursively.

We will deal with the general case by reducing to the one above. Consider the moduli space
\begin{equation*}\label{step 4 recursion space} \VZ^{\leftrightarrow}_{1,\alpha\cup (0)}(\mathbb P|Y_0+Y_\infty,\beta)\end{equation*}
obtained by introducing a marked point $y$ with no tangency. Let $x_1$ be a positive-tangency marking (such a marking always exists since $d \geq 2$) and let $\tilde\gamma$ be the insertion obtained from $\gamma$ by replacing $\ev_1$ and $\psi_1$ by $\ev_y$ and $\psi_y$, and then introducing $\fgt_{1}^\st$ everywhere.

We will make use of a recursion formula for rubber spaces analogous to the recursion formula for relative spaces used in Steps 1--3. Following \cite{EKatz}, there is a line bundle $L_y^{\not\in \operatorname{bot}}$ on $\VZ^{\leftrightarrow}_{1,\alpha\cup (0)}(\mathbb P|Y_0+Y_\infty,\beta)$, together with a section $s_y^{\not\in\operatorname{bot}}$ whose vanishing locus consists of the locus $\Dcal(y)$ of rubber maps where $y$ is not mapped into the bottom level of the expanded target. As in \S \ref{Section Gathmann line bundle}, we can give a logarithmic interpretation of this: it corresponds to the piecewise-linear function on the tropical moduli space which associates, to every rubber tropical map, the distance between $\varphi(\sqC_y)$ and the leftmost vertex of the tropical target, where $\sqC_y$ is the vertex of the source curve containing the flag corresponding to $y$. Using this tropical description, we may easily calculate the vanishing orders of $s_y^{\not\in\operatorname{bot}}$ along the various components of $\Dcal(y)$, and show that $\cchern_1(L_y^{\not\in\operatorname{bot}}) = \Psi_0 - \ev_y^\st Y$ (see also \cite{EKatzLB}, where similar results in the non-reduced setting are obtained, using different methods). From this, we obtain a rubber recursion formula
\begin{equation}\label{step 4 recursion} (\Psi_0 - \ev_y^\st Y) \tilde\gamma \cap [\VZ^{\leftrightarrow}_{1,\alpha\cup(0)}(\mathbb P|Y_0+Y_\infty,\beta)] = \tilde\gamma \cap [\Dcal(y)]\end{equation}
where the fundamental class $[\Dcal(y)]$ is weighted by vanishing orders on the components. We will first show that the left-hand side is recursively known. By construction the class $\tilde\gamma$ is pulled back via $\fgt_{1}^\st$, and the same is true for $\ev_y^\st Y$. It remains to examine $\Psi_0$. If there exists a negative-tangency marking $x_2$, then we have \cite[Construction 5.1.17]{GathmannThesis}
\begin{equation*}\label{Psi0 formula} \Psi_0 = -\alpha_2 \hat\psi_2 - \ev_2^\st Y \end{equation*}
where $\hat\psi_2$ is a \textbf{non-collapsed} psi class. (If there are no negative-tangency markings, then the construction given in \cite[\S 1.5.2]{MaulikPandharipande} shows that $\Psi_0=0$.) Now, $\hat\psi_2 - \psi_2$ is given by the loci where $x_2$ belongs to a trivial bubble. This entails a splitting of the curve into pieces, each of which contributes a rubber integral. Typically each of these pieces will have $(g^\prime,d^\prime,n^\prime,m^\prime) < (1,d,n,m)$ and hence be recursively known. The one exception is when all of the genus and degree is concentrated on the top level of the expansion, with the bottom level containing only a single non-relative marking in addition to all the negative-tangency markings. But in this case the contribution is a rubber invariant where all of the insertions are pulled back via $\fgt_1^\st$, and hence we may apply the projection formula to identify this with an absolute invariant of $Y$ which is recursively known. We conclude that, up to recursively known terms, we may replace $\hat\psi_2$ by $\psi_2$ in the left-hand side of \eqref{step 4 recursion}. If we now compare $\psi_2$ with $\fgt_1^\st \psi_2$ we see that the difference is given by the locus where $x_1$ and $x_2$ belong to a collapsed rational piece. The contribution of this locus consists of rubber invariant with strictly fewer relative markings, and hence is recursively known. So up to recursively-known terms \eqref{step 4 recursion} becomes
\begin{equation*} \fgt_1^\st (-\alpha_2\psi_2 - \ev_y^\st Y)\tilde\gamma \cap [\VZ^{\leftrightarrow}_{1,\alpha\cup(0)}(\mathbb P|Y_0+Y_\infty,\beta)] = \tilde\gamma\cap[\Dcal(y)]\end{equation*}
and now the left-hand side is also recursively known, by the projection formula. Let us now examine the right-hand side. The components of $\Dcal(y)$ are indexed by splittings of the curve, and certainly the contributions are recursively known unless there is a piece of the curve carrying all of the genus and degree, so we may restrict to examining these contributions.

\DIFdelbegin \DIFdel{Let us denote }\DIFdelend \DIFaddbegin \DIFadd{Denote }\DIFaddend the piece of the curve carrying all of the genus and degree by $C^\prime\subseteq C$. If $C^\prime$ is mapped to top level, then either it contains $x_1$, in which case we apply $\fgt_1$ to compute the contribution, or it does not contains $x_1$, in which case it has fewer than $n$ relative markings and is known recursively.  If on the other hand $C^\prime$ is not mapped to top level, then generically it is mapped to the bottom level (since generically the core is not contracted on this locus, so the desingularisation process does nothing). One possible contribution is given by the following locus
\begin{center}
\begin{tikzpicture}[scale=1]
%edge
\draw (0,0) to (2,0);
\draw [color=blue] (1,0) node[below]{\tiny$\alpha_1$};

%C_1
\draw [fill=white] (0,0) circle[radius=3pt];
\draw (0,-0.1) node[below]{\small$d$};

%y
\draw [->] (2,0) -- (2,1);
\draw (2,0.9) node[left]{$y$};
\draw [color=blue] (2,0.5) node[right]{\tiny$0$};

%x_1
\draw [->] (2,0) -- (3,0);
\draw (3,0) node[right]{$x_1$};
\draw [color=blue] (2.5,0) node[below]{\tiny$\alpha_1$};

%C_0
\draw [fill=black] (2,0) circle[radius=3pt];
\draw (2,-0.1) node[below]{\small$0$};

%down arrow
\draw [color=blue,->] (1,-0.5) -- (1,-0.9);

%target
\draw [color=blue] (0,-1) to (2,-1);
\draw [fill=blue,color=blue] (0,-1) circle[radius=3pt];
\draw [fill=blue,color=blue] (2,-1) circle[radius=3pt];
\draw [color=blue,->] (2,-1) -- (3,-1);
\draw [color=blue,->] (0,-1) -- (-1,-1);
\end{tikzpicture}
\end{center}
which contributes a nonzero multiple of the invariant $I$ we are trying to compute. For the other possibilities, first note that, unless every component at the top level contains a single positive-tangency marking and a single node (together with possibly some tangency-zero markings), then $C^\prime$ has fewer than $n$ relative markings and hence the contribution is known recursively. On the other hand, if any non-relative marking other than $y$ is mapped to the top level, $C^\prime$ has $\leq n$ relative markings and less than $m$ non-relative markings, and hence again the contribution is known recursively. The only remaining possibilities are when $x_1$ is replaced by another positive-tangency marking $x_k$ in the above picture; but then the contribution can be calculated by applying the projection formula to $\fgt_{1}$. We therefore conclude that the only contribution to the right-hand side of \eqref{step 4 recursion} which is not known recursively is a nonzero multiple of the invariant we were trying to compute. This completes the recursion step.

\bibliographystyle{alpha}
\bibliography{Bibliography}

\bigskip\bigskip

\noindent Luca Battistella\\
Max-Planck-Institut f\"ur Mathematik, Bonn \\
\href{mailto:battistella@mpim-bonn.mpg.de}{battistella@mpim-bonn.mpg.de}\\

\noindent Navid Nabijou \\
School of Mathematics and Statistics, University of Glasgow \\
\href{mailto:Navid.Nabijou@glasgow.ac.uk}{navid.nabijou@glasgow.ac.uk}\\

\noindent Dhruv Ranganathan \\
Department of Pure Mathematics and Mathematical Statistics, University of Cambridge \\
\href{mailto:dr508@cam.ac.uk}{dr508@cam.ac.uk}

\end{document}